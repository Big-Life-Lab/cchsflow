---
title: "Working with Smoking Variables"
subtitle: "A comprehensive guide to smoking harmonization in cchsflow"
format: 
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: false
    theme: default
editor: visual
---

# Introduction

This vignette provides a comprehensive guide to working with smoking variables in cchsflow. The smoking variable harmonization system supports the creation of smoking history generator models across all CCHS cycles from 2001 to 2024, including both public use (PUMF) and master database formats.

## Key Features

-   **Cross-cycle harmonization**: Consistent smoking variables across all CCHS cycles (2001-2024)
-   **Database compatibility**: Supports both PUMF (\_p) and master (\_m) databases
-   **Supports smoking history generator models**: Essential variables for longitudinal smoking pattern analysis

## Priority Variables

The smoking harmonization system prioritizes **SMKDSTY_A** as the primary smoking status variable for smoking history generator models, with comprehensive support for:

-   Time since quit smoking calculations
-   Age started smoking harmonization
-   Pack-years exposure calculations
-   Smoking status classifications

# Smoking Status

## Overview

Smoking status classification is the foundation of smoking history generator models. The **SMKDSTY_A** variable provides a comprehensive 6-category smoking status classification that works consistently across all CCHS cycles.

## Smoking Status Variable Hierarchy

```         
SMKDSTY_A (6 categories) - PRIORITY VARIABLE for smoking history generator models
├── 1: Daily smoker
├── 2: Occasional smoker (former daily)  
├── 3: Occasional smoker (never daily)
├── 4: Former daily smoker
├── 5: Former occasional smoker
└── 6: Never smoked

Other smoking status variants (implemented as needed):
├── SMKDSTY_B (6 categories, 2015+ cycles) - Same as A but derived differently
├── SMKDSTY_cat5 (5 categories) - Simplified classification
├── SMKDSTY_cat3 (3 categories) - Basic classification  
└── smoke_simple (4 categories) - Simple time-based classification
```

## Variable Coverage by Cycle

The smoking status harmonization strategy adapts to the evolution of CCHS questionnaires:

-   **2001-2014**: Direct SMKDSTY variable available (use raw values)
-   **2015-2024**: Derived from SMK_005, SMK_030, SMK_01A (use functions)

## Harmonization Strategy

-   Use `calculate_smoking_status_detailed()` for all cycles requiring SMKDSTY_A
-   Function handles both raw SMKDSTY (early cycles) and derived logic (recent cycles)
-   CSV-driven approach ensures consistent mappings across all databases

## Classification Logic

The SMKDSTY_A classification uses three input variables to create six smoking status categories:

### Input Variables

-   **SMK_005**: Type of smoker presently (1=daily, 2=occasional, 3=not at all)
-   **SMK_030**: Ever smoked daily in lifetime (1=yes, 2=no)
-   **SMK_01A**: Smoked 100+ cigarettes in lifetime (1=yes, 2=no)

### Classification Rules

1.  **Daily smoker** (SMK_005 = 1) → 1
2.  **Occasional smoker (former daily)** (SMK_005 = 2 & SMK_030 = 1) → 2
3.  **Occasional smoker (never daily)** (SMK_005 = 2 & SMK_030 ≠ 1) → 3
4.  **Former daily smoker** (SMK_005 = 3 & SMK_030 = 1) → 4
5.  **Former occasional smoker** (SMK_005 = 3 & SMK_030 = 2 & SMK_01A = 1) → 5
6.  **Never smoked** (SMK_005 = 3 & SMK_01A = 2) → 6

## Usage Examples

### Standard Harmonization Workflow

``` r
library(cchsflow)

# Harmonize smoking status across any CCHS cycle
result <- rec_with_table(
  data = your_data,
  variables = "SMKDSTY_A", 
  database_name = "cchs2017_2018_p",  # Works for any cycle 2001-2024
  variable_details = variable_details
)

# The result contains harmonized SMKDSTY_A variable
# Uses direct mapping for 2001-2014, derived function for 2015-2024
```

### Multi-cycle Analysis

``` r
# Harmonize smoking status across multiple cycles
cycle1 <- rec_with_table(cchs2009_2010_p, "SMKDSTY_A", "cchs2009_2010_p", variable_details)
cycle2 <- rec_with_table(cchs2017_2018_p, "SMKDSTY_A", "cchs2017_2018_p", variable_details)

# Combine cycles for longitudinal analysis
combined <- merge_rec_data(cycle1, cycle2)
```

### Direct Function Usage (Advanced)

``` r
# For advanced users who need direct function access
smoking_status <- calculate_smoking_status_detailed(
  SMK_005 = c(1, 2, 2, 3, 3, 3), # Daily, occasional, occasional, former, former, former
  SMK_030 = c(1, 1, 2, 1, 2, 2), # Ever daily status
  SMK_01A = c(1, 1, 1, 1, 1, 2)  # ≥100 cigarettes lifetime
)
# Result: c(1, 2, 3, 4, 5, 6) - daily, occ-former, occ-never, former-daily, former-occ, never
```

### Missing Data and Edge Cases

**Important**: Understanding missing data patterns is crucial for smoking history generator models.

``` r
# Missing data examples showing function logic
missing_data_examples <- calculate_smoking_status_detailed(
  SMK_005 = c(6, 7, 8, 9, 3, 3, 2),    # Missing codes, former smokers, occasional
  SMK_030 = c(1, 2, 996, 997, 996, 2, 6), # Valid, missing codes
  SMK_01A = c(1, 1, 1, 1, 1, 1, 1)     # All valid
)
# Result: c(NA::a, NA::b, NA::b, NA::b, NA::b, 5, 3)
# - Codes 6 → tagged_na("a"), codes 7-9 → tagged_na("b") 
# - SMK_005=3 with SMK_030=996 (missing) → tagged_na("b")
# - SMK_005=3, SMK_030=2, SMK_01A=1 → 5 (former occasional)
# - SMK_005=2, SMK_030=6 (missing) → 3 (occasional never daily)

# Critical edge case: Former smokers with missing SMK_030 data
edge_case <- calculate_smoking_status_detailed(
  SMK_005 = 3,    # Former smoker
  SMK_030 = 996,  # Missing: "not applicable" 
  SMK_01A = 1     # Smoked ≥100 cigarettes
)
# Result: tagged_na("b") 
# NOTE: This case falls through to missing (matches legacy behavior)
# Should be validated against actual CCHS question flow
```

## Implementation Status

✅ **SMKDSTY_A is Ready for Production**:

1.  **Cross-Cycle Compatibility**: Works for both 2001-2014 (direct) and 2015-2024 (derived) cycles
2.  **PUMF and Master Support**: Configured for both public use (\_p) and master (\_i, \_s, \_m) databases
3.  **Function Accuracy**: 100% behavioral compatibility with legacy implementation
4.  **CSV Integration**: Fully integrated into variable_details.csv system

# Additional Smoking Variables

## Time Since Quit Smoking

*Coming soon: Documentation for time_quit_smoking harmonization*

## Age Started Smoking

*Coming soon: Documentation for age started smoking harmonization*

## Pack-Years Calculations

*Coming soon: Documentation for pack-years exposure calculations*

# Technical Reference

## Function Reference

-   `calculate_smoking_status_detailed()` - Primary SMKDSTY_A function
-   `calculate_smoking_status()` - Alias for detailed function
-   `calculate_time_quit_smoking()` - Time since quit calculations
-   `calculate_pack_years()` - Pack-years exposure calculations

## Variable Details CSV Configuration

All smoking variable harmonization is configured through the `variable_details.csv` file, providing:

-   Consistent mappings across cycles
-   Missing data handling patterns
-   Validation rules and bounds
-   Function specifications for derived variables

## Missing Data Handling

All smoking functions use structured missing data handling with `haven::tagged_na()`:

-   `tagged_na("a")` - Not applicable (CCHS code 6, 996)
-   `tagged_na("b")` - Missing/invalid response (CCHS codes 7-9, 997-999)
-   `tagged_na("c")` - Question not asked
-   `tagged_na("d")` - Variable missing

### Missing Data Patterns in Smoking Status

**CCHS Missing Code Mapping:**
- **Code 6/996**: "Not applicable" → `tagged_na("a")`
- **Codes 7-9/997-999**: "Don't know", "Refusal", "Not stated" → `tagged_na("b")`

**Critical Edge Cases:**
1. **Former smokers with missing SMK_030**: Falls through to `tagged_na("b")` (matches legacy behavior)
2. **Occasional smokers with missing SMK_030**: Classified as "never daily" (category 3)
3. **Missing SMK_01A with valid other variables**: May affect classification accuracy

**Recommendation**: Validate these patterns against actual CCHS question flow for specific cycles.