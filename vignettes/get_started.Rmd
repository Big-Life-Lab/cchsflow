---
title: "Get started"
output: rmarkdown::html_vignette
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{1 - using cchsflow}     
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = "#>")
```

## Load packages

```{r eval= FALSE}
# Install release version from CRAN
    install.packages("cchsflow")

# Install the most recent version from GitHub
    devtools::install_github("Big-Life-Lab/cchsflow")
```

```{r results= 'hide', message = FALSE, warning=FALSE}
library(cchsflow)
```

The vignettes use the `bind_rows` function in the [dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8) package to 
combine datasets.

```{r results = 'hide', message = FALSE, warning =FALSE}
library(dplyr)
```
## Step 1. Transform variables into haromonized versions

Use`rec_with_table()` to transform the variables of a CCHS dataset.

### Example 1. Transform a single variable from a single database

In this example, the `sex` variable in the 2001 CCHS cycle is transformed into a 
harmonized `sex` variable that is consistent all CCHS cycles.

```{r, warning=FALSE}
sex2001 <- rec_with_table(cchs2001_p, "DHH_SEX", log = TRUE)

get_label(sex2001)
get_labels(sex2001)
```

```{r, echo=FALSE}
head(sex2001)
```

`cchs2001_p` is the name of test CCHS data that is included in the `cchsflow`
library. `cchsflow` includes test CCHS data for the public use microdata file 
(PUMF) for all general household survey (.1 versions) between 2001 and 2013. 
Each suvey cycle has a sample of 200 respondents. `cchs2000_p` indicates this is 
the CCHS 2001 PUMF file. See [Reference](../reference/index.html) for more 
information of each CCHS cycle.

`DHH_SEX` is the name of the harmonized variable for sex. Up to 2007, the 
variable names in CCHS changed every cycle. Since 2007, there has _generally_ 
been a consistent name. `cchsflow` uses the variable name from the 2007 cycle whenever 
possible. For example, in the CCHS 2001, the variable for sex is `DHHA_SEX` and
in CCHS 2007 the same variable is `DHH_SEX`. This name, `DHH_SEX` is the 
harmonized name for sex, meaning `DHHA_SEX` is transformed to `DHH_SEX` using 
rec_with_table(). 

The rules for the transformation in two dataframes that are included in `cchsflow`:
 `variables` and `variable_details`. We will discuss later how to find the names of the common transformed variables. There are also vignettes that further describe `variables` and `variable_details`, including how to add or customize transformed variables.
 
 ### Which variables are transformed? How "good" is the transformation?
 
`cchsflow` includes commonly used sociodemogrphaphic, health behaviour and health status variables.

There are four different types of variables that can be transformed, including variables that are:

1) Consistent and unchanged across all cycles. These variables have no changes to the wording of the question that was asked, the response values and who was asked the question (same inclusion criteria and skip pattern). These variables have no additional notes.

2) Mostly consistent across cycles. These variables may have a small change in wording or response category. Notes for these variables are printed to the console and form a `notes` variable in `variable_details`. Caution is required when using these variables. The notes should be reviewed to assess whether these variables can be used in your study.

3) Either not collected in all cycles or have major changes between cycles. These variable may be included in `cchsflow` with a note that says which cycles include the variable and can be transformed to a common variable.

4) Mostly consistent but with complex changes or transformation rules. These "Potentially problematic variables" are discussed in th reference guide (see ....).

5) Not consistent between cycles. Variable that are inconsistent or not asked in most cycles are not included in `cchsflow`. In the future, we hope to include these variables with an marker that they've been reviewed but rejected from inclusion in `cchsflow`. 

### Example 2. Variable transfomation with a note

```{r}
BMI2001 <- rec_with_table(cchs2001_p, "HWTGBMI", log = TRUE)

```
BMI has several notes reflecting a number of changes that occurred over the CCHS. Notice that the note included advice to use `HWTGBMI_der`. Despite the large number of notes, BMI can be used for most studies because the common transformed variable `HWTGBMI_der` was derived from height and weight variables that are included and largely unchanged across CCHS cycles. However, to use `HWTGBMI_der` you'll also need to include the transformed measures for height (`HWTGHTM`) and weight (`HWTGWTK`).

More information about `HWTGBMI_der` can be found in the documentation reference for 'derived variable functions' or by typing `?BMI_fun` in the R console.

```{r}
BMI2001C <- rec_with_table(cchs2001_p,  
                           c("HWTGHTM", "HWTGWTK", "HWTGBMI_der"), 
                           log = TRUE)
?bmi_fun
```
 
 ### Variable names and labels included
 
By default, `rec_w_table` can include variable and value labels for the harmonized variables. 
 
hmm, not sure what is going on here....
```{r, warning=FALSE}
sex2001 <- rec_with_table(cchs2001_p, "DHH_SEX", log = TRUE, var_labels = c(var_name = "DHH_SEX"))

get_label(sex2001)
attr(sex2001$DHH_SEX, 'label') <- "Sex"
get_label(sex2001)
```

Labels can then be used in plots and tables.
```{r fig1, fig.height = 5, fig.width = 7, warning=FALSE}

barplot(
  table(as_label(sex2001$DHH_SEX)),
  col = cm.colors(5),
  ylim = c(0, 140),
  legend = TRUE,
  main = attr(sex2001$DHH_SEX, 'label'),
  ylab = 'Frequency (n)'
  )
```
 
### Default arguments

With `rec_with_table()` there are also default arguments that do not need to be called unless you would like to modify them.

  + `variables` defaults to NULL. This results in the `variables.csv` sheet in the cchsflow package being used to specify which variables to transform. This argument can be modified if you want use your own `variables.csv` sheet or by specifying particular variables to transform.
  + `database_name` defaults to NULL. This results in `rec_with_table()` using the database indicated in the `data` argument.
  + `variable_details` defaults to NULL. This results in the `variable_details.csv` sheet in the cchsflow being used. This argument can be modified if want use your own `variable_details.csv` sheet.
  + `else_value` defaults to NA. Values out of range set to NA.
  + `append_to_data` defaults to FALSE. Transformed variables will not be appended to the original CCHS dataset.
  + `log` defaults to FALSE. Logs of the variable transformations will not be displayed. 
  + `notes` defaults to TRUE. Information in the `Notes` column from `variable_details.csv` will be displayed
  + `var_labels` is set to NULL. This argument can be used to add labels to a transformed dataset that only contains a subset of variables from `variables.csv`. The format to add labels to a subset of variables is `c(variable = "Label")`.
  
------ end here -------

## Steps

### Step 1. Transform variables into haromonized versions

Load the CCHS datasets as well as the two variable worksheets. There are sample datasets for each CCHS cycle saved in `cchsflow`. For this vignette we will use sample data from the 2001 and 2012 CCHS cycles. 

Did you notice that the names for the variables are slightly different in the two mock databases? That isn't a mistake: in the 2001 CCHS the variable for sex is `DHHA_SEX` and in 2012 CCHS the variable is `DHH_SEX`. 

Don't worry, `cchsflow` is here to help! `variable_details.csv` contains the rules on how to harmonize those two variables into a common variable name. In the CCHS, the categories for `sex` are consistent: 1 = males, 2 = females. `variable_details.csv` provides instructions for how to harmonize category values and labels, if they change across survey cycles. Variable labels are discussed in later vignettes.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
datatable(variables, options = list(pageLength = 5))
cat("`variables.csv` includes", length(unique(variables$variable)), "variables that can be transformed. The variables are divided into", length(unique(variables$section)), "sections, and", length(unique(variables$subject)), "subjects.")
```

### Step 2. Transform variables

To call the `rec_with_table()` function to transform the variables of a CCHS dataset:

1. Create a name for your transformed dataset (e.g. cchs_transformedYear1)
2. Indicate the database of the CCHS dataset in the `data` argument

Your R command when calling the function should look like this:

`cchs_transformedYear1 <- rec_with_table(data = cchsYear1)`

### Default arguments

With `rec_with_table()` there are also default arguments that do not need to be called unless you would like to modify them.

  + `variables` defaults to NULL. This results in the `variables.csv` sheet in the cchsflow package being used to specify which variables to transform. This argument can be modified if you want use your own `variables.csv` sheet or by specifying particular variables to transform.
  + `database_name` defaults to NULL. This results in `rec_with_table()` using the database indicated in the `data` argument.
  + `variable_details` defaults to NULL. This results in the `variable_details.csv` sheet in the cchsflow being used. This argument can be modified if want use your own `variable_details.csv` sheet.
  + `else_value` defaults to NA. Values out of range set to NA.
  + `append_to_data` defaults to FALSE. Transformed variables will not be appended to the original CCHS dataset.
  + `log` defaults to FALSE. Logs of the variable transformations will not be displayed. 
  + `notes` defaults to TRUE. Information in the `Notes` column from `variable_details.csv` will be displayed
  + `var_labels` is set to NULL. This argument can be used to add labels to a transformed dataset that only contains a subset of variables from `variables.csv`. The format to add labels to a subset of variables is `c(variable = "Label")`.

### Example 1. Transform a single variable from a single database

In this example, the `sex` variable in the 2001 CCHS cycle is transformed into a harmonized `sex` variable for all CCHS cycles.

```{r, warning=FALSE}
sex2001 <- rec_with_table(cchs2001_p, "DHH_SEX", log = TRUE)
```

```{r, echo=FALSE}
head(sex2001)
```

### Combine transformed datasets into a single dataset 

Use the `bind_rows` function to combine datasets and create a new dataset name. NOTE: `bind_rows` along with other R functions will likely remove labels in your newly combined dataset. Step 4 explains how to add labels to your final dataset. 

`combined_cchs <- bind_rows(cchs_transformedYear1, cchs_transformedYear2, ...)`

### Example 2. Transform a single variable from multiple CCHS datasets

This example shows how you can transform and combine a variable across multiple CCHS cycles. The sex variable in CCHS 2001 (`DHHA_SEX`) and CCHS 2012 (`DHH_SEX`) is transformed a common variable (`DHH_SEX`) and combined into a single dataset. In `cchsflow` the CCHS 2007 variable name is used as the common variable name. See the [variable_details vignette](variable_details.html) for more information.

```{r, warning = FALSE}
sex2001 <- rec_with_table(cchs2001_p, "DHH_SEX", log = TRUE)
head(sex2001)

sex2012 <- rec_with_table(cchs2012_p, "DHH_SEX", log = TRUE)
tail(sex2012)
```

```{r, warning=FALSE}
combined_sex <- bind_rows(sex2001, sex2012)
```

```{r, echo=FALSE}
head(combined_sex)
tail(combined_sex)
```

### Example 3. Transform a single variable from multiple databases that changes categories between cycles.

There are many variables in the CCHS that changes in categories between cycles in a way that the variable cannot preserve all categories for all CCHS cycles. An example is the categorical variable for `age`. `cchsflow` offers three options to facilitate the use of these variables with inconsistent categories across cycles.

#### Option 1: transform category `age` variable into a common variable for only cycles with the same category responses

Transform the `age` variable into variables that cannot be combined across cycles. The categories in `age` variable in the CCHS changed in 2005 and therefore it is not possible to have the same `age` categories across all CCHS cycles. 

`DHHGAGE_A` is the age variable for CCHS cycles 2001-2003, and `DHHGAGE_B` is the age variable for CCHS cycles 2005-2014. 

```{r, warning=FALSE}
age2001 <- rec_with_table(cchs2001_p, "DHHGAGE_A")
head(age2001)

age2012 <- rec_with_table(cchs2012_p, "DHHGAGE_B")
tail(age2012)
```

```{r, warning=FALSE}
combined_age_cat <- bind_rows(age2001, age2012)
```

```{r, echo=FALSE}
head(combined_age_cat)
tail(combined_age_cat)
```

#### Option 2: transform the categorical `age` variable into a continuous `age_cont` variable

Transform categorical variables such as `age` into a single harmonized `age_cont` variable. This variable takes the midpoint age of each category for all CCHS cycles. With this option, the age category variable from all CCHS cycles can be combined into a single dataset.

```{r, warning=FALSE}
age2001_cont <- rec_with_table(cchs2001_p, "DHHGAGE_cont")
head(age2001_cont)

age2012_cont <- rec_with_table(cchs2012_p, "DHHGAGE_cont")
tail(age2012_cont)
```

```{r, warning= FALSE}
combined_age_cont <- bind_rows(age2001_cont, age2012_cont)
```

```{r, echo=FALSE}
head(combined_age_cont)
tail(combined_age_cont)
```

#### Option 3: transform the categorical `age` variable into a harmonized categorical variable

`cchsflow` often includes a common harmonized categorical variable that has new, consistent categories across all cycles. These new categorical variables generally have fewer category levels than the original variables, reflecting the need to combine categories. Read the `Notes` variable for details.

## Label variables and categories.

Use the `set_data_labels()` function to label the variables in your final dataset. `rec_with_table()` labels individual datasets. `set_data_labels()` labels combined dataset that lose labels when datasets are combined. 

`labeled_combined_cchs <- set_data_labels(data_to_label = combined_cchs, variable_details = variable_details, variables_sheet = variables)`

### Example 4. Transform multiple variables from multiple datasets

The variables argument in `rec_with_table()` allows multiple variables to be transformed from a CCHS dataset. In this example, the age and sex variables from the 2001 and 2012 CCHS datasets will be transformed and labeled using `rec_with_table()`. They will then be combined into a single dataset and labeled using `set_data_labels()`.

```{r, warning=FALSE}
age_sex_2001 <- rec_with_table(cchs2001_p, c("DHHGAGE_cont", "DHH_SEX"),
                var_labels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(age_sex_2001)

age_sex_2012 <- rec_with_table(cchs2012_p, c("DHHGAGE_cont", "DHH_SEX"),
                var_labels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(age_sex_2012)
```

In the above example, `var_labels` is called in `rec_with_table()` to label the age and sex variables in the 2001 and 2012 datasets. Use `get_label()` to view the variable labels in your transformed dataset. As mentioned previously, varLabels can be used all the variables in `variables.csv` or a subset of variables. 

```{r, warning=FALSE}
combined_age_sex <- bind_rows(age_sex_2001, age_sex_2012)
labeled_combined_age_sex <- set_data_labels(data_to_label = combined_age_sex,
            variable_details = variable_details, variables_sheet = variables)
```

In the above code, `set_data_labels()` is used to label the combined age and sex dataset. Similar to before, you can check if labels have been added using `get_label()`.

```{r, warning=FALSE}
get_label(labeled_combined_age_sex)
```

For more information on `get_label()` and other label helper functions, please refer to the [sjlabelled](https://strengejacke.github.io/sjlabelled/reference/) package.

### Example 5. Transform all variables in the variable_details sheet

All the variables listed in `variables.csv` & `variable_details.csv` will be transformed if the variables argument in `rec_with_table()` is not specified. In this example, all variables specified in the two worksheets will be transformed, combined, and labeled for the 2001 and 2012 CCHS cycles.

```{r, echo=FALSE}
options(htmlwidgets.TOJSON_ARGS = list(na = 'string'))
```

```{r, warning=FALSE}
transformed2001 <- rec_with_table(data = cchs2001_p, notes = FALSE)

transformed2012 <- rec_with_table(data = cchs2012_p, notes = FALSE)

combined_cchs <- bind_rows(transformed2001, transformed2012)
labeled_combined_cchs <- set_data_labels(data_to_label = combined_cchs,
              variable_details = variable_details, variables_sheet = variables)
```

### Example 6. Transform CCHS derived variables such as Body Mass Index (BMI)

CCHS derived variables are recoded (harmonized) using the same method as other CCHS `cchsflow` variables, with one additional considerations.

Derived variables in CCHS are created from existing, original variables that are transformed into a new variable. An example is body mass index (BMI). Respondents are asked to report their height and weight. BMI is then derived (calculated) using recoded variables for height and weight. 

Recoding `BMI` into a harmonized variable requires their underlying initial variables (height and weight). This first step of harmonizing underlying variables is completed for you, but you must have the underlying variables in your dataset. 

Using the BMI example illustrated in the [derived variables](derived_variables.html) article, `rec_with_table()` is able to transform BMI across multiple cycles provided that height (`HWTGHTM`) and weight (`HWTGWTK`) are specified.

```{r, warning=FALSE}
bmi2001 <- rec_with_table(cchs2001_p, c("HWTGHTM", "HWTGWTK", "HWTGBMI_der"),
                          log = TRUE)

head(bmi2001)

bmi2012 <- rec_with_table(cchs2012_p, c("HWTGHTM", "HWTGWTK", "HWTGBMI_der"),
                          log = TRUE)
tail(bmi2012)

combined_bmi <- bind_rows(bmi2001, bmi2012)

head(combined_bmi)
tail(combined_bmi)
```

## Notes

`notes` provide context for the decisions that informed harmonization that may affect your decision to use a harmonized variable. 

```{r}
cat("`cchsflow` includes", length(unique(variable_details$notes)), "variables with notes.")
```

For example, for `DHHGAGE_A` the category `NA::b` has the following `note`:

`Not applicable, don't know, refusal, not stated (96-99) were options only in CCHS 2003, but had zero responses`.

This note informs the decision to combine values 96 to 99 in `DHHGAGE_A` for CCHS2003 into one common missing value `NA::b`. The label for the `NA::b` category is, "`don't know (97); refusal (98); not stated (99)`".

By default, `rec_with_table()` prints notes to the console.

## Warning messages

Warning messages will appear when your dataset is missing variables in your `variables` worksheet or `rec_with_table()` call.

