<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Derived Variable Development Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="derived_variables_development_files/libs/clipboard/clipboard.min.js"></script>
<script src="derived_variables_development_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="derived_variables_development_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="derived_variables_development_files/libs/quarto-html/popper.min.js"></script>
<script src="derived_variables_development_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="derived_variables_development_files/libs/quarto-html/anchor.min.js"></script>
<link href="derived_variables_development_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="derived_variables_development_files/libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="derived_variables_development_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="derived_variables_development_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="derived_variables_development_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#types-of-derived-variables" id="toc-types-of-derived-variables" class="nav-link" data-scroll-target="#types-of-derived-variables"><span class="header-section-number">1.1</span> Types of derived variables</a></li>
  <li><a href="#modern-design-principles" id="toc-modern-design-principles" class="nav-link" data-scroll-target="#modern-design-principles"><span class="header-section-number">1.2</span> Modern design principles</a></li>
  </ul></li>
  <li><a href="#architecture-and-design-patterns" id="toc-architecture-and-design-patterns" class="nav-link" data-scroll-target="#architecture-and-design-patterns"><span class="header-section-number">2</span> Architecture and design patterns</a>
  <ul class="collapse">
  <li><a href="#function-architecture-four-tier-design" id="toc-function-architecture-four-tier-design" class="nav-link" data-scroll-target="#function-architecture-four-tier-design"><span class="header-section-number">2.1</span> Function architecture (four-tier design)</a>
  <ul class="collapse">
  <li><a href="#tier-1-constants-and-configuration" id="toc-tier-1-constants-and-configuration" class="nav-link" data-scroll-target="#tier-1-constants-and-configuration"><span class="header-section-number">2.1.1</span> Tier 1: Constants and configuration</a></li>
  <li><a href="#tier-2-core-utilities" id="toc-tier-2-core-utilities" class="nav-link" data-scroll-target="#tier-2-core-utilities"><span class="header-section-number">2.1.2</span> Tier 2: Core utilities</a></li>
  <li><a href="#tier-3-specialized-helpers" id="toc-tier-3-specialized-helpers" class="nav-link" data-scroll-target="#tier-3-specialized-helpers"><span class="header-section-number">2.1.3</span> Tier 3: Specialized helpers</a></li>
  <li><a href="#tier-4-public-api-functions" id="toc-tier-4-public-api-functions" class="nav-link" data-scroll-target="#tier-4-public-api-functions"><span class="header-section-number">2.1.4</span> Tier 4: Public API functions</a></li>
  </ul></li>
  <li><a href="#missing-data-handling-framework" id="toc-missing-data-handling-framework" class="nav-link" data-scroll-target="#missing-data-handling-framework"><span class="header-section-number">2.2</span> Missing data handling framework</a>
  <ul class="collapse">
  <li><a href="#three-stage-transformation-pipeline" id="toc-three-stage-transformation-pipeline" class="nav-link" data-scroll-target="#three-stage-transformation-pipeline"><span class="header-section-number">2.2.1</span> Three-stage transformation pipeline</a></li>
  <li><a href="#universal-preprocessing-functions" id="toc-universal-preprocessing-functions" class="nav-link" data-scroll-target="#universal-preprocessing-functions"><span class="header-section-number">2.2.2</span> Universal preprocessing functions</a></li>
  <li><a href="#tagged-na-semantic-meaning" id="toc-tagged-na-semantic-meaning" class="nav-link" data-scroll-target="#tagged-na-semantic-meaning"><span class="header-section-number">2.2.3</span> Tagged NA semantic meaning</a></li>
  </ul></li>
  <li><a href="#function-design-patterns" id="toc-function-design-patterns" class="nav-link" data-scroll-target="#function-design-patterns"><span class="header-section-number">2.3</span> Function design patterns</a>
  <ul class="collapse">
  <li><a href="#pattern-1-auto-detection-and-validation-modes" id="toc-pattern-1-auto-detection-and-validation-modes" class="nav-link" data-scroll-target="#pattern-1-auto-detection-and-validation-modes"><span class="header-section-number">2.3.1</span> Pattern 1: Auto-detection and validation modes</a></li>
  <li><a href="#pattern-2-unified-categoricalcontinuous-handling" id="toc-pattern-2-unified-categoricalcontinuous-handling" class="nav-link" data-scroll-target="#pattern-2-unified-categoricalcontinuous-handling"><span class="header-section-number">2.3.2</span> Pattern 2: Unified categorical/continuous handling</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#development-workflow" id="toc-development-workflow" class="nav-link" data-scroll-target="#development-workflow"><span class="header-section-number">3</span> Development workflow</a>
  <ul class="collapse">
  <li><a href="#step-1-variable-planning-and-design" id="toc-step-1-variable-planning-and-design" class="nav-link" data-scroll-target="#step-1-variable-planning-and-design"><span class="header-section-number">3.1</span> Step 1: Variable planning and design</a>
  <ul class="collapse">
  <li><a href="#documentation-requirements" id="toc-documentation-requirements" class="nav-link" data-scroll-target="#documentation-requirements"><span class="header-section-number">3.1.1</span> Documentation requirements</a></li>
  <li><a href="#design-checklist" id="toc-design-checklist" class="nav-link" data-scroll-target="#design-checklist"><span class="header-section-number">3.1.2</span> Design checklist</a></li>
  </ul></li>
  <li><a href="#step-2-function-implementation" id="toc-step-2-function-implementation" class="nav-link" data-scroll-target="#step-2-function-implementation"><span class="header-section-number">3.2</span> Step 2: Function implementation</a>
  <ul class="collapse">
  <li><a href="#function-template" id="toc-function-template" class="nav-link" data-scroll-target="#function-template"><span class="header-section-number">3.2.1</span> Function template</a></li>
  <li><a href="#implementation-guidelines" id="toc-implementation-guidelines" class="nav-link" data-scroll-target="#implementation-guidelines"><span class="header-section-number">3.2.2</span> Implementation guidelines</a></li>
  </ul></li>
  <li><a href="#step-3-testing-framework" id="toc-step-3-testing-framework" class="nav-link" data-scroll-target="#step-3-testing-framework"><span class="header-section-number">3.3</span> Step 3: Testing framework</a>
  <ul class="collapse">
  <li><a href="#comprehensive-test-structure" id="toc-comprehensive-test-structure" class="nav-link" data-scroll-target="#comprehensive-test-structure"><span class="header-section-number">3.3.1</span> Comprehensive test structure</a></li>
  <li><a href="#test-execution-and-validation" id="toc-test-execution-and-validation" class="nav-link" data-scroll-target="#test-execution-and-validation"><span class="header-section-number">3.3.2</span> Test execution and validation</a></li>
  </ul></li>
  <li><a href="#step-4-documentation-and-integration" id="toc-step-4-documentation-and-integration" class="nav-link" data-scroll-target="#step-4-documentation-and-integration"><span class="header-section-number">3.4</span> Step 4: Documentation and integration</a>
  <ul class="collapse">
  <li><a href="#update-variable-tracking-files" id="toc-update-variable-tracking-files" class="nav-link" data-scroll-target="#update-variable-tracking-files"><span class="header-section-number">3.4.1</span> Update variable tracking files</a></li>
  <li><a href="#generate-documentation" id="toc-generate-documentation" class="nav-link" data-scroll-target="#generate-documentation"><span class="header-section-number">3.4.2</span> Generate documentation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#testing-best-practices" id="toc-testing-best-practices" class="nav-link" data-scroll-target="#testing-best-practices"><span class="header-section-number">4</span> Testing best practices</a>
  <ul class="collapse">
  <li><a href="#comprehensive-validation-approach" id="toc-comprehensive-validation-approach" class="nav-link" data-scroll-target="#comprehensive-validation-approach"><span class="header-section-number">4.1</span> Comprehensive validation approach</a>
  <ul class="collapse">
  <li><a href="#unit-testing-strategy" id="toc-unit-testing-strategy" class="nav-link" data-scroll-target="#unit-testing-strategy"><span class="header-section-number">4.1.1</span> 1. Unit testing strategy</a></li>
  <li><a href="#integration-testing" id="toc-integration-testing" class="nav-link" data-scroll-target="#integration-testing"><span class="header-section-number">4.1.2</span> 2. Integration testing</a></li>
  <li><a href="#regression-testing" id="toc-regression-testing" class="nav-link" data-scroll-target="#regression-testing"><span class="header-section-number">4.1.3</span> 3. Regression testing</a></li>
  </ul></li>
  <li><a href="#performance-considerations" id="toc-performance-considerations" class="nav-link" data-scroll-target="#performance-considerations"><span class="header-section-number">4.2</span> Performance considerations</a>
  <ul class="collapse">
  <li><a href="#efficiency-guidelines" id="toc-efficiency-guidelines" class="nav-link" data-scroll-target="#efficiency-guidelines"><span class="header-section-number">4.2.1</span> Efficiency guidelines</a></li>
  <li><a href="#performance-testing" id="toc-performance-testing" class="nav-link" data-scroll-target="#performance-testing"><span class="header-section-number">4.2.2</span> Performance testing</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#migration-from-legacy-functions" id="toc-migration-from-legacy-functions" class="nav-link" data-scroll-target="#migration-from-legacy-functions"><span class="header-section-number">5</span> Migration from legacy functions</a>
  <ul class="collapse">
  <li><a href="#modernization-checklist" id="toc-modernization-checklist" class="nav-link" data-scroll-target="#modernization-checklist"><span class="header-section-number">5.1</span> Modernization checklist</a></li>
  <li><a href="#example-migration" id="toc-example-migration" class="nav-link" data-scroll-target="#example-migration"><span class="header-section-number">5.2</span> Example migration</a>
  <ul class="collapse">
  <li><a href="#legacy-pattern-deprecated" id="toc-legacy-pattern-deprecated" class="nav-link" data-scroll-target="#legacy-pattern-deprecated"><span class="header-section-number">5.2.1</span> Legacy pattern (deprecated):</a></li>
  <li><a href="#modern-pattern-v3.0.0" id="toc-modern-pattern-v3.0.0" class="nav-link" data-scroll-target="#modern-pattern-v3.0.0"><span class="header-section-number">5.2.2</span> Modern pattern (v3.0.0):</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#advanced-topics" id="toc-advanced-topics" class="nav-link" data-scroll-target="#advanced-topics"><span class="header-section-number">6</span> Advanced topics</a>
  <ul class="collapse">
  <li><a href="#custom-missing-data-patterns" id="toc-custom-missing-data-patterns" class="nav-link" data-scroll-target="#custom-missing-data-patterns"><span class="header-section-number">6.1</span> Custom missing data patterns</a></li>
  <li><a href="#multi-variable-derived-functions" id="toc-multi-variable-derived-functions" class="nav-link" data-scroll-target="#multi-variable-derived-functions"><span class="header-section-number">6.2</span> Multi-variable derived functions</a></li>
  <li><a href="#integration-with-external-validation" id="toc-integration-with-external-validation" class="nav-link" data-scroll-target="#integration-with-external-validation"><span class="header-section-number">6.3</span> Integration with external validation</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">7</span> Conclusion</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Derived Variable Development Guide</h1>
<p class="subtitle lead">Modern tidyverse approach for developing and testing derived variables in cchsflow</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This guide provides comprehensive instructions for developing, testing, and implementing derived variables in cchsflow using modern tidyverse patterns. The approach emphasizes type safety, readable code, robust missing data handling, and comprehensive validation.</p>
<section id="types-of-derived-variables" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="types-of-derived-variables"><span class="header-section-number">1.1</span> Types of derived variables</h2>
<p>cchsflow supports two primary types of derived variables:</p>
<ol type="1">
<li><strong>Variable mapping</strong> - harmonizing existing CCHS variables across cycles</li>
<li><strong>Calculated variables</strong> - creating new variables from mathematical functions or complex logic</li>
</ol>
<p>This guide focuses on <strong>calculated derived variables</strong> that require custom R functions.</p>
</section>
<section id="modern-design-principles" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="modern-design-principles"><span class="header-section-number">1.2</span> Modern design principles</h2>
<p>Our current approach follows these key principles established through the v3.0.0 smoking function modernization:</p>
<ul>
<li><strong>Tidyverse-first</strong>: Use <code>dplyr::case_when()</code>, <code>haven::tagged_na()</code>, and type-safe operations</li>
<li><strong>Universal robustness</strong>: Functions work across all database types (PUMF, shared, master)</li>
<li><strong>Copy-paste philosophy</strong>: Functions are self-contained with explicit package references</li>
<li><strong>Comprehensive missing data handling</strong>: Standardized preprocessing of original CCHS codes</li>
<li><strong>Zero breaking changes</strong>: Full backward compatibility while adding functionality</li>
</ul>
</section>
</section>
<section id="architecture-and-design-patterns" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Architecture and design patterns</h1>
<section id="function-architecture-four-tier-design" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="function-architecture-four-tier-design"><span class="header-section-number">2.1</span> Function architecture (four-tier design)</h2>
<p>Based on the smoking function modernization, derived variable functions follow a standardized four-tier architecture:</p>
<section id="tier-1-constants-and-configuration" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="tier-1-constants-and-configuration"><span class="header-section-number">2.1.1</span> Tier 1: Constants and configuration</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Age bounds and validation constants</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>MIN_SMOKING_INITIATION_AGE <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>MAX_SMOKING_INITIATION_AGE <span class="ot">&lt;-</span> <span class="dv">95</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable-specific bounds (future: migrate to variable_details.csv)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>SMOKING_AGE_BOUNDS <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">SMKG203_cont =</span> <span class="fu">list</span>(<span class="at">min =</span> <span class="dv">8</span>, <span class="at">max =</span> <span class="dv">84</span>),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">SMKG207_cont =</span> <span class="fu">list</span>(<span class="at">min =</span> <span class="dv">8</span>, <span class="at">max =</span> <span class="dv">95</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tier-2-core-utilities" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="tier-2-core-utilities"><span class="header-section-number">2.1.2</span> Tier 2: Core utilities</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing data preprocessing (universal across variables)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"R/missing-data-helpers.R"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable-specific preprocessing helpers</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>validate_smoking_initiation_age <span class="ot">&lt;-</span> <span class="cf">function</span>(age_var, <span class="at">min_age =</span> <span class="dv">8</span>, <span class="at">max_age =</span> <span class="dv">95</span>) {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    age_var <span class="sc">&lt;</span> min_age <span class="sc">|</span> age_var <span class="sc">&gt;</span> max_age <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> age_var</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tier-3-specialized-helpers" class="level3" data-number="2.1.3">
<h3 data-number="2.1.3" class="anchored" data-anchor-id="tier-3-specialized-helpers"><span class="header-section-number">2.1.3</span> Tier 3: Specialized helpers</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Context-specific transformation functions</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>classify_smoking_status <span class="ot">&lt;-</span> <span class="cf">function</span>(smkdsty_value) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    smkdsty_value <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"daily_smoker"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    smkdsty_value <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"occasional_smoker"</span>, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    smkdsty_value <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"never_smoker"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    smkdsty_value <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"former_smoker"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="cn">NA_character_</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tier-4-public-api-functions" class="level3" data-number="2.1.4">
<h3 data-number="2.1.4" class="anchored" data-anchor-id="tier-4-public-api-functions"><span class="header-section-number">2.1.4</span> Tier 4: Public API functions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note v3.0.0, last updated: 2025-06-30, status: active</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>derived_variable_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(input_vars...) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Implementation using tiers 1-3</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="missing-data-handling-framework" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="missing-data-handling-framework"><span class="header-section-number">2.2</span> Missing data handling framework</h2>
<section id="three-stage-transformation-pipeline" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="three-stage-transformation-pipeline"><span class="header-section-number">2.2.1</span> Three-stage transformation pipeline</h3>
<p>All derived variables follow this standardized missing data preprocessing:</p>
<ol type="1">
<li><strong>Original CCHS codes</strong> (6,7,8,9) → <strong>Harmonized categories</strong> (NA::a, NA::b)</li>
<li><strong>String-based NAs</strong> (“Not applicable”, “Missing”) → <strong>Haven tagged NAs</strong></li>
<li><strong>Type validation</strong> → <strong>Final haven::tagged_na() output</strong></li>
</ol>
</section>
<section id="universal-preprocessing-functions" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="universal-preprocessing-functions"><span class="header-section-number">2.2.2</span> Universal preprocessing functions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard response variables (SMK_005, SMK_030, etc.)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>input_var <span class="ot">&lt;-</span> <span class="fu">preprocess_standard_response</span>(input_var)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorical age variables (SMKG203, SMKG207, etc.)  </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>input_var <span class="ot">&lt;-</span> <span class="fu">preprocess_categorical_age</span>(input_var)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Continuous variables with 996,997,998,999 codes</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>input_var <span class="ot">&lt;-</span> <span class="fu">preprocess_continuous_standard</span>(input_var)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoking-specific variables (auto-detection)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>input_var <span class="ot">&lt;-</span> <span class="fu">preprocess_smoking_variable</span>(input_var, <span class="at">variable_name =</span> <span class="st">"SMK_005"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tagged-na-semantic-meaning" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="tagged-na-semantic-meaning"><span class="header-section-number">2.2.3</span> Tagged NA semantic meaning</h3>
<ul>
<li><code>haven::tagged_na("a")</code> - <strong>Not applicable</strong> (valid skip, age restrictions)</li>
<li><code>haven::tagged_na("b")</code> - <strong>Missing data</strong> (don’t know, refusal, not stated)</li>
</ul>
</section>
</section>
<section id="function-design-patterns" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="function-design-patterns"><span class="header-section-number">2.3</span> Function design patterns</h2>
<section id="pattern-1-auto-detection-and-validation-modes" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="pattern-1-auto-detection-and-validation-modes"><span class="header-section-number">2.3.1</span> Pattern 1: Auto-detection and validation modes</h3>
<p>Functions automatically detect validation requirements and database contexts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>bmi_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(HWTGHTM, HWTGWTK, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">min_HWTGHTM =</span> <span class="fl">0.82</span>, <span class="at">max_HWTGHTM =</span> <span class="fl">2.50</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">min_HWTGWTK =</span> <span class="fl">22.7</span>, <span class="at">max_HWTGWTK =</span> <span class="fl">209.1</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">BMI_min =</span> <span class="dv">10</span>, <span class="at">BMI_max =</span> <span class="dv">100</span>) {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Auto-detect validation mode based on parameters</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  validate_params <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.null</span>(<span class="fu">c</span>(min_HWTGHTM, max_HWTGHTM, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                                   min_HWTGWTK, max_HWTGWTK)))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply preprocessing</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  HWTGHTM <span class="ot">&lt;-</span> <span class="fu">preprocess_continuous_standard</span>(HWTGHTM)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  HWTGWTK <span class="ot">&lt;-</span> <span class="fu">preprocess_continuous_standard</span>(HWTGWTK)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Main calculation with validation</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  bmi_calculated <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(HWTGHTM) <span class="sc">|</span> <span class="fu">is.na</span>(HWTGWTK) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    validate_params <span class="sc">&amp;</span> (HWTGHTM <span class="sc">&lt;</span> min_HWTGHTM <span class="sc">|</span> HWTGHTM <span class="sc">&gt;</span> max_HWTGHTM) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    validate_params <span class="sc">&amp;</span> (HWTGWTK <span class="sc">&lt;</span> min_HWTGWTK <span class="sc">|</span> HWTGWTK <span class="sc">&gt;</span> max_HWTGWTK) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> HWTGWTK <span class="sc">/</span> (HWTGHTM<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final BMI validation</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    validate_params <span class="sc">&amp;</span> (bmi_calculated <span class="sc">&lt;</span> BMI_min <span class="sc">|</span> bmi_calculated <span class="sc">&gt;</span> BMI_max) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> bmi_calculated</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pattern-2-unified-categoricalcontinuous-handling" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="pattern-2-unified-categoricalcontinuous-handling"><span class="header-section-number">2.3.2</span> Pattern 2: Unified categorical/continuous handling</h3>
<p>Functions handle both categorical CCHS codes and continuous research values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>time_quit_smoking_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(SMK_09A_B, SMKG09C, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">min_SMKG09C =</span> <span class="cn">NULL</span>, <span class="at">max_SMKG09C =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Preprocess both inputs</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  SMK_09A_B <span class="ot">&lt;-</span> <span class="fu">preprocess_smoking_variable</span>(SMK_09A_B)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Auto-detect categorical vs continuous SMKG09C</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(SMKG09C <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">96</span>, <span class="dv">97</span>, <span class="dv">98</span>, <span class="dv">99</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    SMKG09C <span class="ot">&lt;-</span> <span class="fu">preprocess_categorical_age</span>(SMKG09C)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    SMKG09C <span class="ot">&lt;-</span> <span class="fu">preprocess_smoking_variable</span>(SMKG09C)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert categorical to continuous</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  SMKG09C_cont <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.numeric</span>(SMKG09C) <span class="sc">~</span> <span class="fu">as.numeric</span>(SMKG09C),  <span class="co"># Already continuous</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    SMKG09C <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">4</span>,   <span class="co"># 3-5 years category</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    SMKG09C <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">8</span>,   <span class="co"># 6-10 years category  </span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    SMKG09C <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">12</span>,  <span class="co"># 11+ years category</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(SMKG09C, <span class="st">"a"</span>) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"a"</span>),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Main calculation</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    SMK_09A_B <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> SMKG09C_cont,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    SMK_09A_B <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    SMK_09A_B <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="fl">1.5</span>, </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    SMK_09A_B <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="fl">2.5</span>,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(SMK_09A_B, <span class="st">"a"</span>) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"a"</span>),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="development-workflow" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Development workflow</h1>
<section id="step-1-variable-planning-and-design" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="step-1-variable-planning-and-design"><span class="header-section-number">3.1</span> Step 1: Variable planning and design</h2>
<section id="documentation-requirements" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="documentation-requirements"><span class="header-section-number">3.1.1</span> Documentation requirements</h3>
<p>Before coding, document your derived variable in:</p>
<ol type="1">
<li><strong><code>inst/extdata/variables.csv</code></strong> - Add the new variable entry</li>
<li><strong><code>inst/extdata/variable_details.csv</code></strong> - Map across cycles with <code>Func::function_name</code></li>
<li><strong>Function specification</strong> - Document inputs, outputs, validation rules</li>
</ol>
</section>
<section id="design-checklist" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="design-checklist"><span class="header-section-number">3.1.2</span> Design checklist</h3>
<ul class="task-list">
<li><label><input type="checkbox">Identify all input CCHS variables required</label></li>
<li><label><input type="checkbox">Determine validation bounds and edge cases<br>
</label></li>
<li><label><input type="checkbox">Plan missing data handling strategy</label></li>
<li><label><input type="checkbox">Consider backward compatibility requirements</label></li>
<li><label><input type="checkbox">Document expected output format and categories</label></li>
</ul>
</section>
</section>
<section id="step-2-function-implementation" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="step-2-function-implementation"><span class="header-section-number">3.2</span> Step 2: Function implementation</h2>
<section id="function-template" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="function-template"><span class="header-section-number">3.2.1</span> Function template</h3>
<p>Use this template for all new derived variable functions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Derived Variable Function Title</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @description Brief description of what the function calculates and its purpose</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'   in CCHS harmonization. Reference any relevant health measurement standards.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param input_var1 Primary CCHS variable description</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param input_var2 Secondary CCHS variable description  </span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param min_param Optional minimum validation bound (default NULL)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max_param Optional maximum validation bound (default NULL)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param validate_params Auto-detect validation mode (default NULL)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Numeric or categorical derived variable. Returns haven::tagged_na("a") </span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   for not applicable cases, haven::tagged_na("b") for missing/invalid data.</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' **Calculation Method:**</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' Brief mathematical or logical description</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' **Missing Data Handling:**</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Original CCHS codes (6,7,8,9) preprocessed to haven::tagged_na()</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Invalid measurements tagged as haven::tagged_na("b")</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Not applicable cases tagged as haven::tagged_na("a")</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' **Validation (when enabled):**</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Input bounds: param1 [min, max], param2 [min, max]</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Output bounds: result [min, max]</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Basic CCHS processing</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' derived_var_fun(var1 = c(1, 2, 3), var2 = c(10, 20, 30))</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Research mode with validation</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' derived_var_fun(var1 = c(1.5, 2.1), var2 = c(15.2, 25.8),</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">#'                min_param1 = 1, max_param1 = 5)</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' @references</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' Include relevant academic or methodological references</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note v3.0.0, last updated: 2025-06-30, status: active, Note: Brief change description</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>derived_var_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(input_var1, input_var2, </span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                           <span class="at">min_param1 =</span> <span class="cn">NULL</span>, <span class="at">max_param1 =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                           <span class="at">validate_params =</span> <span class="cn">NULL</span>) {</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Preprocess original CCHS missing codes</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  input_var1 <span class="ot">&lt;-</span> <span class="fu">preprocess_appropriate_pattern</span>(input_var1)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  input_var2 <span class="ot">&lt;-</span> <span class="fu">preprocess_appropriate_pattern</span>(input_var2)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Auto-detect validation mode</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(validate_params)) {</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    validate_params <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.null</span>(min_param1) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.null</span>(max_param1)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Apply parameter validation</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (validate_params) {</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(min_param1)) {</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>      input_var1 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        input_var1 <span class="sc">&lt;</span> min_param1 <span class="sc">|</span> input_var1 <span class="sc">&gt;</span> max_param1 <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">.default =</span> input_var1</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Main calculation using case_when</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define calculation logic</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(input_var1) <span class="sc">|</span> <span class="fu">is.na</span>(input_var2) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... specific calculation cases</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> calculated_value</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Final validation (if enabled)</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (validate_params) {</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>      result <span class="sc">&lt;</span> output_min <span class="sc">|</span> result <span class="sc">&gt;</span> output_max <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> result</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implementation-guidelines" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="implementation-guidelines"><span class="header-section-number">3.2.2</span> Implementation guidelines</h3>
<ol type="1">
<li><strong>Use explicit package references</strong>: <code>dplyr::case_when()</code>, <code>haven::tagged_na()</code></li>
<li><strong>Avoid nested ifelse</strong>: Replace with readable case_when patterns</li>
<li><strong>Consistent missing data handling</strong>: Use preprocessing helpers</li>
<li><strong>Comprehensive documentation</strong>: Include examples for both basic and research use</li>
<li><strong>Semantic versioning</strong>: Update <span class="citation" data-cites="note">@note</span> metadata with version and changes</li>
</ol>
</section>
</section>
<section id="step-3-testing-framework" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="step-3-testing-framework"><span class="header-section-number">3.3</span> Step 3: Testing framework</h2>
<section id="comprehensive-test-structure" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="comprehensive-test-structure"><span class="header-section-number">3.3.1</span> Comprehensive test structure</h3>
<p>Create tests following this template in <code>tests/testthat/test-{variable-name}.R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test Structure for Derived Variables</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"derived_var_fun() handles basic CCHS inputs correctly"</span>, {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test valid inputs</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">derived_var_fun</span>(<span class="fl">1.5</span>, <span class="dv">70</span>), expected_output)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test boundary conditions</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">derived_var_fun</span>(<span class="fl">0.8</span>, <span class="dv">20</span>), expected_boundary_output)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test type consistency</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_type</span>(<span class="fu">derived_var_fun</span>(<span class="fl">1.5</span>, <span class="dv">70</span>), <span class="st">"double"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"derived_var_fun() handles missing data correctly"</span>, {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test original CCHS missing codes</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(<span class="dv">6</span>, <span class="dv">70</span>), <span class="st">"a"</span>))  <span class="co"># Not applicable</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(<span class="dv">7</span>, <span class="dv">70</span>), <span class="st">"b"</span>))  <span class="co"># Don't know</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(<span class="dv">8</span>, <span class="dv">70</span>), <span class="st">"b"</span>))  <span class="co"># Refusal</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(<span class="dv">9</span>, <span class="dv">70</span>), <span class="st">"b"</span>))  <span class="co"># Not stated</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test string NA inputs</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(<span class="st">"Not applicable"</span>, <span class="dv">70</span>), <span class="st">"a"</span>))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(<span class="st">"Missing"</span>, <span class="dv">70</span>), <span class="st">"b"</span>))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test haven::tagged_na inputs (passthrough)</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(<span class="fu">derived_var_fun</span>(haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"a"</span>), <span class="dv">70</span>), <span class="st">"a"</span>))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"derived_var_fun() validation mode works correctly"</span>, {</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test validation enabled</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  result_validated <span class="ot">&lt;-</span> <span class="fu">derived_var_fun</span>(<span class="fl">1.5</span>, <span class="dv">70</span>, <span class="at">min_param1 =</span> <span class="fl">1.0</span>, <span class="at">max_param1 =</span> <span class="fl">2.0</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_false</span>(<span class="fu">is.na</span>(result_validated))</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test out-of-bounds inputs</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  result_invalid <span class="ot">&lt;-</span> <span class="fu">derived_var_fun</span>(<span class="fl">0.5</span>, <span class="dv">70</span>, <span class="at">min_param1 =</span> <span class="fl">1.0</span>, <span class="at">max_param1 =</span> <span class="fl">2.0</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(haven<span class="sc">::</span><span class="fu">is_tagged_na</span>(result_invalid, <span class="st">"b"</span>))</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"derived_var_fun() backward compatibility"</span>, {</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test against legacy implementation (if exists)</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  legacy_result <span class="ot">&lt;-</span> <span class="fu">legacy_derived_var_fun</span>(<span class="fl">1.5</span>, <span class="dv">70</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  modern_result <span class="ot">&lt;-</span> <span class="fu">derived_var_fun</span>(<span class="fl">1.5</span>, <span class="dv">70</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Should produce identical results for valid inputs</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(legacy_result, modern_result, <span class="at">ignore_attr =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"derived_var_fun() integration with rec_with_table()"</span>, {</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test with actual CCHS data</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> cchs2010_p</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test transformation works</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">rec_with_table</span>(test_data, </span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>                          <span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"input_var1"</span>, <span class="st">"input_var2"</span>, <span class="st">"derived_var"</span>),</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>                          <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(<span class="st">"derived_var"</span> <span class="sc">%in%</span> <span class="fu">names</span>(result))</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_type</span>(result<span class="sc">$</span>derived_var, <span class="st">"double"</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="test-execution-and-validation" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="test-execution-and-validation"><span class="header-section-number">3.3.2</span> Test execution and validation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run comprehensive tests</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-your-variable.R"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check test coverage</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>covr<span class="sc">::</span><span class="fu">function_coverage</span>(derived_var_fun, </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">test_file</span>(<span class="st">"tests/testthat/test-your-variable.R"</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Integration testing</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">test</span>()  <span class="co"># Full package test suite</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-4-documentation-and-integration" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="step-4-documentation-and-integration"><span class="header-section-number">3.4</span> Step 4: Documentation and integration</h2>
<section id="update-variable-tracking-files" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="update-variable-tracking-files"><span class="header-section-number">3.4.1</span> Update variable tracking files</h3>
<ol type="1">
<li><strong>Add to variables.csv</strong>:</li>
</ol>
<pre class="csv"><code>variable,variableStart,typeStart,typeEnd,databaseStart,variableStartLabel,variableStartShortLabel,units,recStart,recEnd,notes
derived_var,DerivedVar::[INPUT_VAR1, INPUT_VAR2],cont,cont,all_cycles,Long description,Short desc,unit,func_name,Func::derived_var_fun,Description of purpose</code></pre>
<ol start="2" type="1">
<li><strong>Add detailed mappings to variable_details.csv</strong>:</li>
</ol>
<pre class="csv"><code>variable,dummyVariable,typeEnd,databaseStart,variableStart,recEnd,numValidCat,catLabel,catLabelLong,units,notes,version,last_modified,change_type
derived_var,N/A,cont,cchs2001_p,DerivedVar::[INPUT_VAR1, INPUT_VAR2],Func::derived_var_fun,N/A,N/A,N/A,unit,Description,3.0.0,2025-06-30,new</code></pre>
</section>
<section id="generate-documentation" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="generate-documentation"><span class="header-section-number">3.4.2</span> Generate documentation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update roxygen documentation</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">document</span>()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build package site</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>pkgdown<span class="sc">::</span><span class="fu">build_site</span>()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check documentation completeness</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">check</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="testing-best-practices" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Testing best practices</h1>
<section id="comprehensive-validation-approach" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="comprehensive-validation-approach"><span class="header-section-number">4.1</span> Comprehensive validation approach</h2>
<section id="unit-testing-strategy" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="unit-testing-strategy"><span class="header-section-number">4.1.1</span> 1. Unit testing strategy</h3>
<ul>
<li><strong>Input validation</strong>: Test all parameter combinations</li>
<li><strong>Edge cases</strong>: Boundary values, extreme inputs</li>
<li><strong>Missing data</strong>: All CCHS missing code patterns<br>
</li>
<li><strong>Type safety</strong>: Ensure consistent output types</li>
<li><strong>Performance</strong>: Validate execution time for large datasets</li>
</ul>
</section>
<section id="integration-testing" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="integration-testing"><span class="header-section-number">4.1.2</span> 2. Integration testing</h3>
<ul>
<li><strong>Cross-cycle compatibility</strong>: Test with multiple CCHS cycles</li>
<li><strong>rec_with_table() integration</strong>: Ensure transformation workflows work</li>
<li><strong>Backward compatibility</strong>: Compare against legacy implementations</li>
<li><strong>Real-world validation</strong>: Test with actual CCHS datasets</li>
</ul>
</section>
<section id="regression-testing" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="regression-testing"><span class="header-section-number">4.1.3</span> 3. Regression testing</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Automated regression testing framework</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"derived_var_fun() regression testing"</span>, {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load reference results from previous versions</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  reference_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"tests/testdata/derived_var_reference.rds"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test current implementation against reference</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  current_results <span class="ot">&lt;-</span> <span class="fu">derived_var_fun</span>(reference_data<span class="sc">$</span>input1, reference_data<span class="sc">$</span>input2)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Allow for minor floating-point differences</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(current_results, reference_data<span class="sc">$</span>expected_output, <span class="at">tolerance =</span> <span class="fl">1e-10</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="performance-considerations" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="performance-considerations"><span class="header-section-number">4.2</span> Performance considerations</h2>
<section id="efficiency-guidelines" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="efficiency-guidelines"><span class="header-section-number">4.2.1</span> Efficiency guidelines</h3>
<ol type="1">
<li><strong>Vectorized operations</strong>: Use dplyr operations that work on entire vectors</li>
<li><strong>Minimal memory allocation</strong>: Avoid creating unnecessary intermediate variables</li>
<li><strong>Lazy evaluation</strong>: Let case_when() short-circuit for performance</li>
<li><strong>Efficient missing data handling</strong>: Preprocessing once vs.&nbsp;repeated checks</li>
</ol>
</section>
<section id="performance-testing" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="performance-testing"><span class="header-section-number">4.2.2</span> Performance testing</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark against large datasets</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>large_dataset <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">var1 =</span> <span class="fu">rnorm</span>(<span class="dv">100000</span>, <span class="fl">1.7</span>, <span class="fl">0.1</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">var2 =</span> <span class="fu">rnorm</span>(<span class="dv">100000</span>, <span class="dv">70</span>, <span class="dv">15</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">derived_var_fun</span>(large_dataset<span class="sc">$</span>var1, large_dataset<span class="sc">$</span>var2),</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">100</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="migration-from-legacy-functions" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Migration from legacy functions</h1>
<section id="modernization-checklist" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="modernization-checklist"><span class="header-section-number">5.1</span> Modernization checklist</h2>
<p>When updating existing derived variables to v3.0.0 standards:</p>
<ul class="task-list">
<li><label><input type="checkbox">Replace nested <code>ifelse()</code> with <code>dplyr::case_when()</code></label></li>
<li><label><input type="checkbox">Add missing data preprocessing helpers</label></li>
<li><label><input type="checkbox">Implement auto-detection for validation modes</label></li>
<li><label><input type="checkbox">Add comprehensive parameter validation</label></li>
<li><label><input type="checkbox">Update documentation with modern examples</label></li>
<li><label><input type="checkbox">Maintain backward compatibility</label></li>
<li><label><input type="checkbox">Add comprehensive test coverage</label></li>
<li><label><input type="checkbox">Update <span class="citation" data-cites="note">@note</span> metadata with v3.0.0</label></li>
</ul>
</section>
<section id="example-migration" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="example-migration"><span class="header-section-number">5.2</span> Example migration</h2>
<section id="legacy-pattern-deprecated" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="legacy-pattern-deprecated"><span class="header-section-number">5.2.1</span> Legacy pattern (deprecated):</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Old nested ifelse approach</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>legacy_bmi_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(height, weight) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="fu">is.na</span>(height) <span class="sc">|</span> <span class="fu">is.na</span>(weight), <span class="cn">NA</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(height <span class="sc">&lt;</span> <span class="fl">0.8</span> <span class="sc">|</span> height <span class="sc">&gt;</span> <span class="fl">2.5</span>, <span class="cn">NA</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(weight <span class="sc">&lt;</span> <span class="dv">20</span> <span class="sc">|</span> weight <span class="sc">&gt;</span> <span class="dv">200</span>, <span class="cn">NA</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        weight <span class="sc">/</span> (height<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="modern-pattern-v3.0.0" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="modern-pattern-v3.0.0"><span class="header-section-number">5.2.2</span> Modern pattern (v3.0.0):</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modern case_when approach with preprocessing</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>bmi_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(HWTGHTM, HWTGWTK, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">min_HWTGHTM =</span> <span class="fl">0.82</span>, <span class="at">max_HWTGHTM =</span> <span class="fl">2.50</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">min_HWTGWTK =</span> <span class="fl">22.7</span>, <span class="at">max_HWTGWTK =</span> <span class="fl">209.1</span>) {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Preprocess missing data</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  HWTGHTM <span class="ot">&lt;-</span> <span class="fu">preprocess_continuous_standard</span>(HWTGHTM)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  HWTGWTK <span class="ot">&lt;-</span> <span class="fu">preprocess_continuous_standard</span>(HWTGWTK)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate with validation</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(HWTGHTM) <span class="sc">|</span> <span class="fu">is.na</span>(HWTGWTK) <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    HWTGHTM <span class="sc">&lt;</span> min_HWTGHTM <span class="sc">|</span> HWTGHTM <span class="sc">&gt;</span> max_HWTGHTM <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    HWTGWTK <span class="sc">&lt;</span> min_HWTGWTK <span class="sc">|</span> HWTGWTK <span class="sc">&gt;</span> max_HWTGWTK <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> HWTGWTK <span class="sc">/</span> (HWTGHTM<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="advanced-topics" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Advanced topics</h1>
<section id="custom-missing-data-patterns" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="custom-missing-data-patterns"><span class="header-section-number">6.1</span> Custom missing data patterns</h2>
<p>For variables with unique missing data patterns, create custom preprocessing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>preprocess_custom_variable <span class="ot">&lt;-</span> <span class="cf">function</span>(input_var, <span class="at">custom_codes =</span> <span class="cn">NULL</span>) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(custom_codes)) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    custom_codes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">not_applicable =</span> <span class="fu">c</span>(<span class="dv">96</span>, <span class="dv">97</span>),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">missing =</span> <span class="fu">c</span>(<span class="dv">98</span>, <span class="dv">99</span>, <span class="dv">999</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    input_var <span class="sc">%in%</span> custom_codes<span class="sc">$</span>not_applicable <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"a"</span>),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    input_var <span class="sc">%in%</span> custom_codes<span class="sc">$</span>missing <span class="sc">~</span> haven<span class="sc">::</span><span class="fu">tagged_na</span>(<span class="st">"b"</span>),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> input_var</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="multi-variable-derived-functions" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="multi-variable-derived-functions"><span class="header-section-number">6.2</span> Multi-variable derived functions</h2>
<p>For complex derived variables requiring multiple inputs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>complex_derived_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(var1, var2, var3, var4, ...) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Preprocess all inputs</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  processed_vars <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">list</span>(var1, var2, var3, var4), </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span><span class="fu">preprocess_appropriate_pattern</span>(.x))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unpack processed variables</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list2env</span>(<span class="fu">setNames</span>(processed_vars, <span class="fu">c</span>(<span class="st">"var1"</span>, <span class="st">"var2"</span>, <span class="st">"var3"</span>, <span class="st">"var4"</span>)), </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>           <span class="fu">environment</span>())</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Complex calculation logic</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multi-condition logic here</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> final_calculation</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="integration-with-external-validation" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="integration-with-external-validation"><span class="header-section-number">6.3</span> Integration with external validation</h2>
<p>For research applications requiring external validation datasets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>validated_derived_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs, <span class="at">external_validation =</span> <span class="cn">NULL</span>) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(external_validation)) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply external validation rules</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    validation_result <span class="ot">&lt;-</span> <span class="fu">validate_against_external</span>(inputs, external_validation)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    inputs <span class="ot">&lt;-</span> validation_result<span class="sc">$</span>validated_inputs</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standard calculation</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">derived_var_fun</span>(inputs)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="conclusion" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Conclusion</h1>
<p>This development guide provides the framework for creating robust, maintainable derived variables that follow cchsflow v3.0.0 standards. The approach emphasizes:</p>
<ul>
<li><strong>Type safety</strong> through haven::tagged_na() and consistent preprocessing</li>
<li><strong>Readability</strong> through case_when() patterns and clear documentation<br>
</li>
<li><strong>Robustness</strong> through comprehensive validation and testing</li>
<li><strong>Compatibility</strong> through universal design and backward compatibility</li>
</ul>
<p>By following these patterns, derived variables will integrate seamlessly with the cchsflow ecosystem while providing reliable, well-documented functionality for both basic CCHS processing and advanced research applications.</p>
<p>For questions or issues with derived variable development, consult the existing smoking functions in <code>R/smoking.R</code> as reference implementations of these patterns.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>