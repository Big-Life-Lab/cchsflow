---
title: "Derived variables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1 - using cchsflow}     
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Derived variables in CCHS are created from existing, original variables that are transformed into a new variable. An example is body mass index (BMI). Respondents are not asked to report their BMI, but rather they are asked to report their height and weight. BMI is then derived (calculated) using variables for height and weight. Harmonizing derived variables across CCHS surveys usually required first harmonizing their underlying initial variables. For this reason, `cchsflow` includes variables such as height (`HWTGHTM`) and weight (`HWTGWTK`). 

Transforming derived variables usually requires variable mapping (mapping two or more variables into a single variable) and math (e.g. BMI = weight/height*height). For this reason, variableDetails.csv supports functions, in addition to simple variable recoding. The functions are referenced in `variableDetails.csv` within `variableStart` with the prefix 'DerivedVar::'. For example,  For BMI (`HWTGBMI_derived`) includes `DerivedVar::[HWTGHTM, HWTGWTK]`, which indicates a function with two starting variables (`HWTGHTM, HWTGWTK`).

You can either use existing dervied variable or derive new variables. 

## Example - Using an existing variable - Body Mass Index (BMI)

While BMI is calculated across all CCHS cycles, the method in which it is calculated varies across CCHS cycles, leading to misclassification error that might affect your study. As such, a derived variable for BMI has been created in `cchsflow` that uses harmonized height (HWTGHTM) and weight (HWTGWTK) variables across all CCHS cycles.

Using `RecWTable()` you can transform the derived BMI variable across multiple CCHS cycles and create a transformed dataset.

```{r, eval = FALSE}
install.packages("devtools")
library(devtools)
install_github("Big-Life-Lab/bllflow", ref = "dev")
```

```{r, warning=FALSE, message = FALSE}
library(bllflow)
library(cchsflow)
```

```{r, warning=FALSE}
data(cchs2003)
data(cchs2010)

variables <- read.csv(file.path(getwd(), '../inst/extdata/variables.csv'))
variableDetails <- read.csv(file.path(getwd(), '../inst/extdata/variableDetails.csv'))

BMI2003 <- RecWTable(dataSource = cchs2003, variableDetails = variableDetails, datasetName = "cchs-82M0013-E-2003-c2-1-General File", log = TRUE, variables = c("HWTGHTM", "HWTGWTK", "HWTGBMI_derived"))

BMI2010 <- RecWTable(dataSource = cchs2010, variableDetails = variableDetails, datasetName = "CCHS-82M0013-E-2010-AnnualComponent", log = TRUE, variables = c("HWTGHTM", "HWTGWTK", "HWTGBMI_derived"))
```

Since derived variables are based on previously transformed variables, if you want to only transform your derived variable, you must also specify its base CCHS variables in `RecWTable()` as shown above. So for the derived BMI variable, you will have to also specify the height (`HWTGHTM`) and weight (`HWTGWTK`) variables.

Using `bind_rows()`, you can then combine your transformed datasets.

```{r, warning = FALSE}
library(dplyr)
library(DT)
combinedBMI <- bind_rows(BMI2003, BMI2010)

datatable(combinedBMI)
```

