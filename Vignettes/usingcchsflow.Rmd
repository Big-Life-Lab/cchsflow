---
title: "Using cchsflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1 - using cchsflow}     
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting Started

### Loading the necessary packages

The `RecWTable` and `SetDataLabels` functions are part of the [bllflow](https://bllflow.projectbiglife.ca/index.html) package. `RecWTable` is used to transform CCHS variables to a common name. `SetDataLabels` reapplies labels that are lost during the combination process after transforming each CCHS dataset. Install & load the package onto your environment. Since `bllflow` is still under development and is not on CRAN, you must install the package from Github using the `devtools` package. 

`variables.csv` & `variableDetails.csv` are saved in the cchsflow package as `variables` & `variableDetails`. This means you will need to install & load the page onto your environment. Similar to `bllflow`, you must install the package
from Github.

```{r eval= FALSE}
install.packages("devtools")
library(devtools)
install_github("Big-Life-Lab/bllflow", ref = "dev")
install_github("Big-Life-Lab/cchsflow")
```

```{r results= 'hide', message = FALSE, warning=FALSE}
library(bllflow)
library(cchsflow)
```

We use the `bind_rows` function in the [dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8) package to combine datasets.

```{r results = 'hide', message = FALSE, warning =FALSE}
library(dplyr)
```

We use the `kable` function in the [knitr](https://yihui.name/knitr/) package to illustrate transformation.
```{r results = 'hide', message = FALSE, warning =FALSE}
library(knitr)
library(kableExtra)
```

## Steps

### Step 1. Load the CCHS datasets

Load the CCHS datasets as well as the two variable worksheets. For illustration, we will create mock CCHS datasets for the years 2001 and 2013. 

```{r}
cchsMock2001 <- data.frame(DHHA_SEX = c(2, 1, 1, 6), DHHAGAGE = c(3, 4, 6, 6), FVCADTOT = c(12, 4, 20, 9))
cchsMock2013 <- data.frame(DHH_SEX = c(1, 2, 1), DHHGAGE = c(2, 1, 1), FVCDTOT = c(25, 15, 6))
```

Did you notice that the names for the variables are slightly different in the two mock databases? That isn't a mistake: in the 2001 CCHS the variable for sex is `DHHA_SEX` and in 2013 CCHS the variable is `DHH_SEX`. 

Don't worry, `cchsflow` is here to help! `variableDetails.csv` contains the rules to harmonize those two variables into a common variable name. In the CCHS, the categories for `sex` are consistient: 1 = males, 2 = females. `variableDetails.csv` provides instructions for how to harmonizecategory values or labels, if they change across survey cycles. Variable labes are discussed in later vignettes.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
datatable(variables, options = list(pageLength = 5))
cat("`variables.csv` includes", length(unique(variables$variable)), "variables that can be transformed. The variables are divided into", length(unique(variables$section)), "sections, and", length(unique(variables$subject)), "subjects.")
```

### Step 2. Transform variables

To call the `RecWTable()` function to transform the variables of a CCHS dataset:

1. Create a name for your transformed dataset (e.g. cchsYear1)
2. Indicate the database of the CCHS dataset in the `dataSource` argument
3. Indicate the name of `variableDetails.csv` in the `variableDetails` argument
4. Indicate the name of the CCHS dataset (this can be found in the databaseStart section of `variableDetails.csv`).

Your R command when calling the function should look like this:

`cchsTransformedYear1 <- RecWTable(dataSource = cchsYear, variableDetails = variableDetails, datasetName = "cchsYear1")`

### Default arguments

With `RecWTable()` there are also default arguments that do not need to be called unless you would like to modify them.

  + `elseValue` default to NA. Values out of range set to NA.
  + `appendToData` default to FALSE. Transformed variables will not be appended to the original CCHS dataset.
  + `log` default to FALSE. Logs of the variable tranformations will not be displayed. 
  + `printNote` default to TRUE. Information in the `Notes` column from `variableDetails.csv` will be displayed
  + `variables` default to NULL. This argument can be used to add labels to the transformed dataset by setting it to the name of `variables.csv` or by specifying particular variables from `variables.csv` to transform.
  + `varLabels` is set to NULL. This argument can be used to add labels to a transformed dataset that only contains a subset of variables from `variables.csv`. The format to add labels to a subset of variables is `c(variable = "Label")`.
  
See the `bllflow::RecWTable()` [documentation](http://bllflow.projectbiglife.ca) for more details about how to use RecWTable().

### Example 1. Transform a single variable from a single database

In this example, the `sex` variable in the 2001 CCHS cycle is transformed a harmonized `sex` variable for all CCHS cycles.

```{r, warning=FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = variableDetails, datasetName = "cchs2001", log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
kable(sex2001)
```

### Combine transformed datasets into a single dataset 

Use the `bind_rows` function to combine datasets and create a new dataset name. NOTE: `bind_rows` along with other R functions will likely remove labels in your newly combined dataset. Step 4 explains how to add labels to your final dataset. 

`combinedCCHS <- bind_rows(cchsTransformedYear1, cchsTransformedYear2, ...)`

### Example 2. Transform a single variable from multiple CCHS datasets

This example shows how you can transform and combine a variable across multiple CCHS cycles. The sex variable in CCHS 2001 (`DHHA_SEX`) and CCHS 2013 (`DHH_SEX`) is transformed a common variable (`DHH_SEX`) and combined into a single dataset. In `cchsflow` the CCHS 2007 variable name is used as the common variable name. See the [variableDetails vignette](articles/variableDetails.html) for more information.

```{r, warning = FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = variableDetails, datasetName = "cchs2001", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"))

sex2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = variableDetails, datasetName = "cchs2013", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"))
```

```{r, warning=FALSE}
combinedSex <- bind_rows(sex2001, sex2013)
```

```{r, echo=FALSE}
kable(combinedSex)
```

### Example 3. Transform a single variable from multiple databases that changes categories between cycles.

There are many variables in the CCHS that changes in categories between cycles in a way that the variable cannot perserve all categories for all CCHS cycles. An example is the categorical variable for `age`. `cchsflow` offers three options to facilitate the use of these variables with inconsistent categories across cycles.

#### Option 1: transform category `age` variable into a common variable for only cycles with the same category responses

Transform the `age` variable into variables that cannoot be combined across cycles. The categories in `age` variable in the CCHS changed in 2005 and therefore it is not possible to have the same `age` categories across all CCHS cycles. 

`DHHGAGE_A` is the age variable for CCHS cycles 2001-2003, and `DHHGAGE_B` is the age variable for CCHS cycles 2005-2014. 

```{r, warning=FALSE}
age2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = variableDetails, datasetName = "cchs2001", variables = c("DHHGAGE_A"))

age2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = variableDetails, datasetName = "cchs2013", variables = c("DHHGAGE_B"))
```

```{r, warning=FALSE}
combinedAge_cat <- bind_rows(age2001, age2013)
```

```{r, echo=FALSE}
kable(combinedAge_cat)
```

#### Option 2: transform the categorical `age` variable into a continuous `age_cont` variable

Transform categorical variables such as `age` into a single harmonized `age_cont` variable. This variable takes the midpoint age of each category for all CCHS cycles. With this option, the age category variable from all CCHS cycles can be combined into a single dataset.

```{r, warning=FALSE}
age2001_cont <- RecWTable(dataSource = cchsMock2001, variableDetails = variableDetails, datasetName = "cchs2001", variables = c("DHHGAGE_cont"))

age2013_cont <- RecWTable(dataSource = cchsMock2013, variableDetails = variableDetails, datasetName = "cchs2013", variables = c("DHHGAGE_cont"))
```

```{r, warning= FALSE}
combinedAge_cont <- bind_rows(age2001_cont, age2013_cont)
```

```{r, echo=FALSE}
kable(combinedAge_cont)
```

#### Option 3: transform the categorical `age` variable into a harmonized categorical variable

`cchsflow` often includes a common harmonized categorical variable that has new, consistent variables across all cycles. These new categorical variables generally have few category levels than the original variables, reflecting the need to combine categories. Read the `Notes` variable for details.

### Example 4. Transform multiple variables from multiple datasets

The variables argument in `RecWTable()` allows multiple variables to be transformed from a CCHS dataset. In this example, the age and sex variables from the 2001 and 2013 CCHS datasets will be transformed and labelled using `RecWTable()`. They will then be combined into a single dataset and labelled using `SetDataLabels()`.

```{r, warning=FALSE}
agesex_2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = variableDetails, datasetName = "cchs2001", variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(agesex_2001)

agesex_2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = variableDetails, datasetName = "cchs2013", variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(agesex_2013)
```

In the above example, `varLabels` is called in `RecWTable()` to label the age and sex variables in the 2001 and 2013 datasets. Use `get_label()` to view the variable labels in your transformed dataset. As mentioned previously, varLabels can be used all the variables in `variablesSheet.csv` or a subset of variables. 

```{r, warning=FALSE}
combinedAgeSex <- bind_rows(agesex_2001, agesex_2013)
labelledCombinedAgeSex <- SetDataLabels(dataToLabel = combinedAgeSex, variableDetails = variableDetails, variablesSheet = variables)
```

```{r, echo=FALSE}
kable(labelledCombinedAgeSex)
```

In the above code, `SetDataLabels()` is used to label the combined age and sex dataset. Similar to before, you can check if labels have been added using `get_label()`.

```{r, warning=FALSE}
get_label(labelledCombinedAgeSex)
```

For more information on `get_label()` and other label helper functions, please refer to the [sjlabelled](https://strengejacke.github.io/sjlabelled/reference/) package.

### Example 5. Transform all variables in the variableDetails sheet

All the variables listed in `varDetails.csv` will be transformed if the variables argument in `RecWTable()` is not specified. In this example, all of the variables in our mock 2001 and 2013 datasets will be transformed, combined, and labelled.

```{r, echo=FALSE}
options(htmlwidgets.TOJSON_ARGS = list(na = 'string'))
```

```{r, warning=FALSE}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = variableDetails, datasetName = "cchs2001")
```

```{r, echo=FALSE}
kable(transformed2001)
```

```{r, warning=FALSE}
transformed2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = variableDetails, datasetName = "cchs2013")
```

```{r, echo=FALSE}
kable(transformed2013)
```

```{r, warning=FALSE}
combinedCCHS <- bind_rows(transformed2001, transformed2013)
labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = variableDetails, variablesSheet = variables)
```

```{r, echo=FALSE}
kable(labelledCombinedCCHS)
```

```{r, warning=FALSE}
get_label(labelledCombinedCCHS)
```

### Example 5. Transform CCHS derived variables such as Body Mass Index (BMI)

CCHS derived variables are recoded (harmonized) using the same method as other CCHS `cchsflow` variables, with one additional considerations.

Derived variables in CCHS are created from existing, original variables that are transformed into a new variable. An example is body mass index (BMI). Respondents are asked to report their height and weight. BMI is then dereived (calculated) using variables for height and weight. 

Recoding `BMI` into a harmonized variable requires their underlying initial variables (height and weight). This first step of harmonizing underlying variables is completed for you, but you must have the underlying variables in your dataset. 

Using the BMI example illustrated in the [derivedVariables](articles/derivedVariables.html) article, `RecWTable()` is able to transform BMI across multiple cycles provided that height (`HWTGHTM`) and weight (`HWTGWTK`) are specified.

For this example, we will use a subset of CCHS 2003 and 2010 data.

```{r, eval=FALSE}
BMI2003 <- RecWTable(dataSource = cchs2003, variableDetails = variableDetails, datasetName = "cchs2003", log = TRUE, variables = c("HWTGHTM", "HWTGWTK", "HWTGBMI_derived"))

BMI2010 <- RecWTable(dataSource = cchs2010, variableDetails = variableDetails, datasetName = "cchs2010", log = TRUE, variables = c("HWTGHTM", "HWTGWTK", "HWTGBMI_derived"))

combinedBMI <- bind_rows(BMI2003, BMI2010)

head(combinedBMI)
```

## Notes

`notes` provide context for the decisions that informed harmonization that may affect your decision to use a harmonized variable. 

```{r}
cat("`cchsflow` includes", length(unique(variableDetails$notes)), "variables with notes.")
```

For example, for `DHHGAGE_A` the category `NA::b` has the following `note`:

`Not applicable, don't know, refusal, not stated (96-99) were options only in CCHS 2003, but had zero responses`.

This note informs the decision to combine values 96 to 99 in `DHHGAGE_A` for CCHS2003 into one common missing value `NA::b`. The label for the `NA::b` category is, "`don't know (97); refusal (98); not stated (99)`".

By default, `recWTable()` prints notes to the console.

## Label variables and categories.

Use the `SetDataLabels()` function to label the variables in your final dataset. `RecWTable()` labels individual datasets. `SetDataLabels()` labels combined dataset that loose labels when datatables are combined. 

`labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)`

## Warning messages

Warning messages will appear when your dataset is missing variables in your `variables` worksheet or `recWTable()` call.

