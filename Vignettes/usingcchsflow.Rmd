---
title: "Using cchsflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1 - using cchsflow}     
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting Started

### Loading the necessary packages

The `RecWTable` and `SetDataLabels` functions are part of the [bllflow](https://bllflow.projectbiglife.ca/index.html) package. `RecWTable` is used to transform CCHS variables to a common name. `SetDataLabels` reapplies labels that are lost during the combination process after transforming each CCHS dataset. Install & load the package onto your environment. Since `bllflow` is still under development and is not on CRAN, you must install the package from Github using the `devtools` package.

```{r eval= FALSE}
install.packages("devtools")
library(devtools)
install_github("Big-Life-Lab/bllflow", ref = "derived-variable-creation")
```

```{r results= 'hide', message = FALSE, warning=FALSE}
library(bllflow)
```

We use the `bind_rows` function in the [dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8) package to combine datasets.

```{r results = 'hide', message = FALSE, warning =FALSE}
library(dplyr)
```

We use `datatable` function in the [DT](https://rstudio.github.io/DT/) package to illustrate transformation.
```{r results = 'hide', message = FALSE, warning =FALSE}
library(DT)
```

## Steps

### Step 1. Load the CCHS datasets, variables.csv, and variableDetails.csv

Load the CCHS datasets as well as the two variable worksheets. For illustration, we will create mock CCHS datasets for the years 2001 and 2013. 

```{r}
varSheet <- read.csv(file.path(getwd(), '../inst/extdata/variables.csv'))
varDetails <- read.csv(file.path(getwd(), '../inst/extdata/variableDetails.csv'))
cchsMock2001 <- data.frame(DHHA_SEX = c(2, 1, 1, 6), DHHAGAGE = c(3, 4, 6, 6), FVCADTOT = c(12, 4, 20, 9))
cchsMock2013 <- data.frame(DHH_SEX = c(1, 2, 1), DHHGAGE = c(2, 1, 1), FVCDTOT = c(25, 15, 6))
```

Did you notice that the names for the variables are slightly different in the two mock databases? That isn't a mistake: in the 2001 CCHS the variable for sex is `DHHA_SEX` and in 2013 CCHS the variable is `DHH_SEX`. 

Don't worry, `cchsflow` is here to help! `variableDetails.csv` contains the rules to harmonize those two variables into a common variable name. In the CCHS, the categories for `sex` are consistient: 1 = males, 2 = females. `variableDetails.csv` provides instructions for how to harmonizecategory values or labels, if they change across survey cycles. Variable labes are discussed in later vignettes.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
datatable(varSheet)
cat("`variables.csv` includes", length(unique(varSheet$variable)), "variables that can be transformed. The variables are divided into", length(unique(varSheet$section)), "sections, and", length(unique(varSheet$subject)), "subjects.")
```

### Step 2. Transform variables

To call the `RecWTable()` function to transform the variables of a CCHS dataset:

1. Create a name for your transformed dataset (e.g. cchsYear1)
2. Indicate the database of the CCHS dataset in the `dataSource` argument
3. Indicate the name of `variableDetails.csv` in the `variableDetails` argument
4. Indicate the full name of the CCHS dataset (this can be found in the data documentation of the CCHS dataset) in the `datasetName` argument.

Your R command when calling the function should look like this:

`cchsTransformedYear1 <- RecWTable(dataSource = cchsYear, variableDetails = varDetails, datasetName = "cchs-Year1-general-file")`

### Default arguments

With `RecWTable()` there are also default arguments that do not need to be called unless you would like to modify them.

  + `elseValue` default to NA. Values out of range set to NA.
  + `appendToData` default to FALSE. Transformed variables will not be appended to the original CCHS dataset.
  + `log` default to FALSE. Logs of the variable tranformations will not be displayed. 
  + `printNote` default to TRUE. Information in the `Notes` column from `variableDetails.csv` will be displayed
  + `variables` default to NULL. This argument can be used to add labels to the transformed dataset by setting it to the name of `variables.csv` or by specifying particular variables from `variables.csv` to transform.
  + `varLabels` is set to NULL. This argument can be used to add labels to a transformed dataset that only contains a subset of variables from `variables.csv`. The format to add labels to a subset of variables is `c(variable = "Label")`.
  
See the `bllflow::RecWTable()` [documentation](http://bllflow.projectbiglife.ca) for more details about how to use RecWTable().

### Example 1. Transform a single variable from a single database

In this example, the `sex` variable in the 2001 CCHS cycle is transformed a harmonized `sex` variable for all CCHS cycles.

```{r, warning=FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
datatable(sex2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Combine transformed datasets into a single dataset 

Use the `bind_rows` function to combine datasets and create a new dataset name. NOTE: `bind_rows` along with other R functions will likely remove labels in your newly combined dataset. Step 4 explains how to add labels to your final dataset. 

`combinedCCHS <- bind_rows(cchsTransformedYear1, cchsTransformedYear2, ...)`

### Example 2. Transform a single variable from multiple CCHS datasets

This example shows how you can transform and combine a variable across multiple CCHS cycles. The sex variable in CCHS 2001 (`DHHA_SEX`) and CCHS 2013 (`DHH_SEX`) is transformed a common variable (`DHH_SEX`) and combined into a single dataset. In `cchsflow` the CCHS 2007 variable name is used as the common variable name. See the [variableDetails vignette]() for more information.

```{r, warning = FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
datatable(sex2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
sex2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
datatable(sex2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
combinedSex <- bind_rows(sex2001, sex2013)
```

```{r, echo=FALSE}
datatable(combinedSex, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Example 3. Transform a single variable from multiple databases that changes categories between cycles.

There are many variables in the CCHS that changes in categories between cycles in a way that the variable cannot perserve all categories for all CCHS cycles. An example is the categorical variable for `age`. `cchsflow` offers three options to facilitate the use of these variables with inconsistent categories across cycles.

#### Option 1: transform category `age` variable into a common variable for only cycles with the same category responses

Option 1 transforms the `age` variable into two variables that cannoot be combined across cycles. The categories in `age` variable in the CCHS changed in 2005 and therefore it is not possible to have the same `age` categories across all CCHS cycles. 

`DHHGAGE_A` is the age variable for CCHS cycles 2001-2003, and `DHHGAGE_B` is the age variable for CCHS cycles 2005-2014. 

```{r, warning=FALSE}
age2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", variables = c("DHHGAGE_A"))
```

```{r, echo=FALSE}
datatable(age2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
age2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", variables = c("DHHGAGE_B"))
```

```{r, echo=FALSE}
datatable(age2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```


#### Option 2: transform the categorical `age` variable into a continuous `age_cont` variable

Option 2 transforms categorical variables such as `age` into a single harmonized `age_cont` variable. This variable takes the midpoint age of each category for all CCHS cycles. With this option, the age category variable from all CCHS cycles can be combined into a single dataset.

```{r, warning=FALSE}
age2001_cont <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", variables = c("DHHGAGE_cont"))
```

```{r, echo=FALSE}
datatable(age2001_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
age2013_cont <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", variables = c("DHHGAGE_cont"))
```

```{r, echo=FALSE}
datatable(age2013_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning= FALSE}
combinedAge_cont <- bind_rows(age2001_cont, age2013_cont)
```

```{r, echo=FALSE}
datatable(combinedAge_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

#### Option 3: transform the categorical `age` variable into a harmonized categorical variable

`cchsflow` often includes a common harmonized categorical variable that has new, consistent variables across all cycles. These new categorical variables generally have few category levels than the original variables, reflecting the need to combine categories. Read the `Notes` variable for details.

### Step 3. Label variables and categories.

Use the `SetDataLabels()` function to label the variables in your final dataset. `RecWTable()` labels individual datasets. `SetDataLabels()` labels combined dataset that loose labels when datatables are combined. 

`labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)`

### Example 4. Transform multiple variables from multiple datasets

The variables argument in `RecWTable()` allows multiple variables to be transformed from a CCHS dataset. In this example, the age and sex variables from the 2001 and 2013 CCHS datasets will be transformed and labelled using `RecWTable()`. They will then be combined into a single dataset and labelled using `SetDataLabels()`.

```{r, warning=FALSE}
agesex_2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(agesex_2001)

agesex_2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(agesex_2013)
```

In the above example, `varLabels` is called in `RecWTable()` to label the age and sex variables in the 2001 and 2013 datasets. Use `get_label()` to view the variable labels in your transformed dataset. As mentioned previously, varLabels can be used all the variables in `variablesSheet.csv` or a subset of variables. 

```{r, warning=FALSE}
combinedAgeSex <- bind_rows(agesex_2001, agesex_2013)
labelledCombinedAgeSex <- SetDataLabels(dataToLabel = combinedAgeSex, variableDetails = varDetails, variablesSheet = varSheet)
```

```{r, echo=FALSE}
datatable(labelledCombinedAgeSex, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:2)), dom = 't'))
```

In the above code, `SetDataLabels()` is used to label the combined age and sex dataset. Similar to before, you can check if labels have been added using `get_label()`.

```{r, warning=FALSE}
get_label(labelledCombinedAgeSex)
```

For more information on `get_label()` and other label helper functions, please refer to the [sjlabelled](https://strengejacke.github.io/sjlabelled/reference/) package.

### Example 5. Transform all variables in the variableDetails sheet

All the variables listed in `varDetails.csv` will be transformed if the variables argument in `RecWTable()` is not specified. In this example, all of the variables in our mock 2001 and 2013 datasets will be transformed, combined, and labelled.

```{r, echo=FALSE}
options(htmlwidgets.TOJSON_ARGS = list(na = 'string'))
```

```{r, warning=FALSE}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file")
```

```{r, echo=FALSE}
datatable(transformed2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:4)), dom = 't'))
```

```{r, warning=FALSE}
transformed2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component")
```

```{r, echo=FALSE}
datatable(transformed2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:4)), dom = 't'))
```

```{r, warning=FALSE}
combinedCCHS <- bind_rows(transformed2001, transformed2013)
labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)
```

```{r, echo=FALSE}
datatable(labelledCombinedCCHS, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:5)), dom = 't'))
```

```{r, warning=FALSE}
get_label(labelledCombinedCCHS)
```

### Warning messages

Warning messages will appear when the variables in your dataset do not match the variables in your two worksheets. 

In our example, our mock CCHS datasets only contain a two of variables from `variables.csv` and `varDetails.csv`. 

As such, warning messages about variables not included in our datasets will be printed. 

```{r, echo=FALSE, results="hide", warning=2}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file")
```

## Using your own CCHS dataset to transform variables

At this time, the CCHS datasets cannot be shared publicly. But that does not mean you cannot use a saved CCHS dataset on your computer to transform variables. However, we have included a sample of 200 respondents in the CCHS 2003 and 2009 that you can use to try `cchsflow`.

```{r, eval=FALSE}
head(cchs2003)
```