---
title: "Transform CCHS variables"
date: 'Last updated: 2019-08-27'
output: rmarkdown::html_vignette
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting Started
### Loading the necessary packages

The `RecWTable` and `SetDataLabels` functions are part of the [bllflow](https://bllflow.projectbiglife.ca/index.html) package. `RecWTable` is used to transform CCHS variables to a common name, while `SetDataLabels` reapplies labels that are lost during the combination process after transforming each CCHS dataset. You must install & load the package onto your environment in order to do any transformations. To be able to combine datasets with minimal issues, we recommend using the `bind_rows` function in the [dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8) package. 

```{r results = 'hide', message = FALSE, warning =FALSE}
library(bllflow)
library(dplyr)
```

For this vignette, we will use the `datatable` function in the [DT](https://rstudio.github.io/DT/) package to provide data tables to illustrate the transformations.
```{r results = 'hide', message = FALSE, warning =FALSE}
library(DT)
```

## Steps
### Step 1. Loading the CCHS datasets, variables.csv, and variableDetails.csv

You will need to load the CCHS datasets as well as the two variable worksheets before you are able to do any transformations. Since CCHS datasets cannot be shared publicly, we will create mock CCHS datasets for the years 2001 and 2013 which will be used in examples later on. 

```{r}
varSheet <- read.csv(file.path(getwd(), '../inst/extdata/variables.csv'))
varDetails <- read.csv(file.path(getwd(), '../inst/extdata/variableDetails.csv'))
cchsMock2001 <- data.frame(DHHA_SEX = c(2, 1, 1, 6), DHHAGAGE = c(3, 4, 6, 6), FVCADTOT = c(12, 4, 20, 9))
cchsMock2013 <- data.frame(DHH_SEX = c(1, 2, 1), DHHGAGE = c(2, 1, 1), FVCDTOT = c(25, 15, 6))
```

### Step 2. Creating a transformed dataset for each CCHS cycle

To call the `RecWTable` function to transform the variables of a CCHS dataset:

1. Create a name for your transformed dataset (e.g. cchsYear1)
2. Indicate the database of the CCHS dataset in the `dataSource` argument
3. Indicate the name of `variableDetails.csv` in the `variableDetails` argument
4. Indicate the full name of the CCHS dataset (this can be found in the data documentation of the CCHS dataset) in the `datasetName` argument.

Your R command when calling the function should look like this:

`cchsTransformedYear1 <- RecWTable(dataSource = cchsYear, variableDetails = varDetails, datasetName = "cchs-Year1-general-file")`

### Default arguments

With `RecWTable` there are also default arguments that do not need to be called unless you would like to modify them.

  + `elseValue` is set to NA. Else values (values out of range) will be set to NA.
  + `appendToData` is set to FALSE. Transformed variables will not be appended to the original CCHS dataset.
  + `log` is set to FALSE. Logs of the variable tranformations will not be displayed. 
  + `printNote` is set to TRUE. Any information in the Notes column from `variableDetails.csv` will be displayed
  + `variables` is set to NULL. This argument can be used to add labels to the transformed dataset by setting it to the name of `variables.csv` or by specifying particular variables from `variables.csv` to transform.
  + `varLabels` is set to NULL. This argument can be used to add labels to a transformed dataset that only contains a subset of variables from `variables.csv`. The format to add labels to a subset of variables is `c(variable = "Label")`.

### Step 3. Combining transformed datasets into a single dataset 

Use the `bind_rows` function to combine datasets and create a new dataset name. NOTE: `bind_rows` along with other R functions will likely remove labels in your newly combined dataset. Step 4 explains how to add labels to your final dataset. 

`combinedCCHS <- bind_rows(cchsTransformedYear1, cchsTransformedYear2, ...)`

### Step 4. Labelling your final dataset

Use the `SetDataLabels` function to label the variables in your final dataset.

`labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)`

## Examples
Using the steps outlined above, here are examples of how to transform CCHS variables in multiple scenarios:

### Example 1. Transforming a single variable from a single database

In this example, the sex variable in the 2001 CCHS cycle is transformed.

```{r, warning=FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE, variables = c("DHH_SEX"), varLabels = c(DHH_SEX = "Sex"))
datatable(sex2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Example 2. Transforming a single variable from multiple CCHS datasets

This example shows how you can transform and combine a variable across multiple CCHS cycles. In this example, the sex variable in 2001 and 2013 CCHS cycles is transformed and combined into a single dataset.

```{r, warning = FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"), varLabels = c(DHH_SEX = "Sex"))
datatable(sex2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))

sex2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"), varLabels = c(DHH_SEX = "Sex"))
datatable(sex2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))

combinedSex <- bind_rows(sex2001, sex2013)
labelledCombinedSex <- SetDataLabels(dataToLabel = combinedSex, variableDetails = varDetails, variablesSheet = varSheet)
datatable(labelledCombinedSex, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Example 3. Transforming a single variable from multiple databases that changes categories between cycles.

There are many variables in the CCHS that changes in categories between cycles, such as age. There are two options in using variables like age.

#### Option 1: Using the transformed grouped age variable

The grouped age variable can be transformed into two grouped age variables. `DHHGAGE_A` is the grouped age variable for CCHS cycles 2001-2003, and `DHHGAGE_B` is the grouped age variable for CCHS cycles 2005-2014.

```{r, warning=FALSE}
age2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE, variables = c("DHHGAGE_A"), varLabels = c(DHHGAGE_A = "Age"))
datatable(age2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))

age2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", log = TRUE, variables = c("DHHGAGE_B"), varLabels = c(DHHGAGE_B = "Age"))
datatable(age2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

With this option, you cannot combine `DHHGAGE_A` and `DHHGAGE_B` into a single dataset.

#### Option 2: Using the transformed continuous age variable

The grouped age variable can also be transformed into a single continuous age variable. This variable would take the midpoint of each category for all CCHS cycles.

```{r, warning=FALSE}
age2001_cont <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE, variables = c("DHHGAGE_cont"), varLabels = c(DHHGAGE_cont = "Age"))
datatable(age2001_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))

age2013_cont <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", log = TRUE, variables = c("DHHGAGE_cont"), varLabels = c(DHHGAGE_cont = "Age"))
datatable(age2013_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))

combinedAge_cont <- bind_rows(age2001_cont, age2013_cont)
labelledCombinedAge_cont <- SetDataLabels(dataToLabel = combinedAge_cont, variableDetails = varDetails, variablesSheet = varSheet)
datatable(labelledCombinedAge_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

With this option, the age category variable from all CCHS cycles can be combined into a single dataset.

### Example 4. Transforming multiple variables from multiple datasets

The variables argument in `RecWTable` is able to handle multiple variables to be transformed from a CCHS dataset. In this example, the age and sex variables from the 2001 and 2013 CCHS datasets will be transformed and combined into a single dataset.

```{r, warning=FALSE}
agesex_2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE, variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))
datatable(agesex_2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:2)), dom = 't'))

agesex_2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", log = TRUE, variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))
datatable(agesex_2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:2)), dom = 't'))

combinedAgeSex <- bind_rows(agesex_2001, agesex_2013)
labelledCombinedAgeSex <- SetDataLabels(dataToLabel = combinedAgeSex, variableDetails = varDetails, variablesSheet = varSheet)
datatable(labelledCombinedAgeSex, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:2)), dom = 't'))
```

### Example 5. Transforming all variables in the variable details sheet

If the variables argument in `RecWTable` is not specified, it will transform all the variables listed in `varDetails.csv`. In this example, all of the variables in our mock 2001 and 2013 datasets will be transformed, combined, and labelled.

```{r, warning=FALSE}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE)
datatable(transformed2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:4)), dom = 't'))

transformed2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", log = TRUE)
datatable(transformed2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:4)), dom = 't'))

combinedCCHS <- bind_rows(transformed2001, transformed2013)
labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)
datatable(combinedCCHS, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:5)), dom = 't'))
```

### Warning messages.

When the variables in your dataset do not match the variables in your two worksheets, warning messages will appear. In our example, our mock CCHS datasets only contain a handful of variables from `variables.csv` and `varDetails.csv`. As such, warning messages about variables not included in our datasets will be printed. 

```{r, echo=FALSE, results="hide", warning=2}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE)
```