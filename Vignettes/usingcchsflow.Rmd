---
title: "Using cchsflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1 - using cchsflow}     
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting Started

### Loading the necessary packages

The `RecWTable` and `SetDataLabels` functions are part of the [bllflow](https://bllflow.projectbiglife.ca/index.html) package. `RecWTable` is used to transform CCHS variables to a common name, while `SetDataLabels` reapplies labels that are lost during the combination process after transforming each CCHS dataset. You must install & load the package onto your environment in order to do any transformations. Since `bllflow` is still under development and is not on CRAN, you must install the package from Github using the `devtools` package.

```{r eval= FALSE}
install.packages("devtools")
library(devtools)
install_github("Big-Life-Lab/bllflow", ref = "recode-with-table-patch")
```

```{r results= 'hide', message = FALSE, warning=FALSE}
library(bllflow)
```

To be able to combine datasets with minimal issues, we recommend using the `bind_rows` function in the [dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8) package. 

```{r results = 'hide', message = FALSE, warning =FALSE}
library(dplyr)
```

For this vignette, we will use the `datatable` function in the [DT](https://rstudio.github.io/DT/) package to provide data tables to illustrate the transformations.
```{r results = 'hide', message = FALSE, warning =FALSE}
library(DT)
```

## Steps

### Step 1. Load the CCHS datasets, variables.csv, and variableDetails.csv

You will need to load the CCHS datasets as well as the two variable worksheets before you are able to do any transformations. Since CCHS datasets cannot be shared publicly, we will create mock CCHS datasets for the years 2001 and 2013 which will be used in examples later on. 

```{r}
varSheet <- read.csv(file.path(getwd(), '../inst/extdata/variables.csv'))
varDetails <- read.csv(file.path(getwd(), '../inst/extdata/variableDetails.csv'))
cchsMock2001 <- data.frame(DHHA_SEX = c(2, 1, 1, 6), DHHAGAGE = c(3, 4, 6, 6), FVCADTOT = c(12, 4, 20, 9))
cchsMock2013 <- data.frame(DHH_SEX = c(1, 2, 1), DHHGAGE = c(2, 1, 1), FVCDTOT = c(25, 15, 6))
```

Did you notice that the names for the variables are slightly different in the two mock databases? That isn't a mistake: in the 2001 CCHS the variable for sex is `DHHA_SEX` and in 2013 CCHS the variable is `DHH_SEX`. 

Don't worry, `cchsflow` is here to help! `variableDetails.csv` contains the rules to harmonize those two variables into a common variable name. In the CCHS, the categories for `sex` are consistient: 1 = males, 2 = females. If the category values or labels changed, `variableDetails.csv` would provide instructions for how to harmonize them. You can learn more about these in later vignettes.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)
datatable(varSheet)
cat("As you can see in variables.csv, there are", length(unique(varSheet$variable)), "variables that can be transformed that are divided into", length(unique(varSheet$section)), "sections, and", length(unique(varSheet$subject)), "subjects.")
```

### Step 2. Transform variables

To call the `RecWTable()` function to transform the variables of a CCHS dataset:

1. Create a name for your transformed dataset (e.g. cchsYear1)
2. Indicate the database of the CCHS dataset in the `dataSource` argument
3. Indicate the name of `variableDetails.csv` in the `variableDetails` argument
4. Indicate the full name of the CCHS dataset (this can be found in the data documentation of the CCHS dataset) in the `datasetName` argument.

Your R command when calling the function should look like this:

`cchsTransformedYear1 <- RecWTable(dataSource = cchsYear, variableDetails = varDetails, datasetName = "cchs-Year1-general-file")`

### Default arguments

With `RecWTable()` there are also default arguments that do not need to be called unless you would like to modify them.

  + `elseValue` is set to NA. Else values (values out of range) will be set to NA.
  + `appendToData` is set to FALSE. Transformed variables will not be appended to the original CCHS dataset.
  + `log` is set to FALSE. Logs of the variable tranformations will not be displayed. 
  + `printNote` is set to TRUE. Any information in the Notes column from `variableDetails.csv` will be displayed
  + `variables` is set to NULL. This argument can be used to add labels to the transformed dataset by setting it to the name of `variables.csv` or by specifying particular variables from `variables.csv` to transform.
  + `varLabels` is set to NULL. This argument can be used to add labels to a transformed dataset that only contains a subset of variables from `variables.csv`. The format to add labels to a subset of variables is `c(variable = "Label")`.
  
See the `bllflow::RecWTable()` [documentation](http://bllflow.projectbiglife.ca) for more details about how to use RecWTable().

### Example 1. Transform a single variable from a single database

In this example, the sex variable in the 2001 CCHS cycle is transformed.

```{r, warning=FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
datatable(sex2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Combine transformed datasets into a single dataset 

Use the `bind_rows` function to combine datasets and create a new dataset name. NOTE: `bind_rows` along with other R functions will likely remove labels in your newly combined dataset. Step 4 explains how to add labels to your final dataset. 

`combinedCCHS <- bind_rows(cchsTransformedYear1, cchsTransformedYear2, ...)`

### Example 2. Transform a single variable from multiple CCHS datasets

This example shows how you can transform and combine a variable across multiple CCHS cycles. The sex variable in CCHS 2001 (`DHHA_SEX`) and CCHS 2013 (`DHH_SEX`) is transformed a common variable (`DHH_SEX`) and combined into a single dataset. In `cchsflow` the CCHS 2007 variable name is used as the common variable name. See the [variableDetails vignette]() for more information.

```{r, warning = FALSE}
sex2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
datatable(sex2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
sex2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", appendToData = FALSE, log = TRUE, variables = c("DHH_SEX"))
```

```{r, echo=FALSE}
datatable(sex2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
combinedSex <- bind_rows(sex2001, sex2013)
```

```{r, echo=FALSE}
datatable(combinedSex, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Example 3. Transform a single variable from multiple databases that changes categories between cycles.

There are many variables in the CCHS that changes in categories between cycles in a way that the variable cannot perserve all categories for all CCHS cycles. An example is the categorical variable for `age`. `cchsflow` offer several options to facilitate the use of these variables with inconsistent categories across cycles.

#### Example 3.1: transform category `age` variable into a common variable for only cycles with the same category responses

The categories in `age` variable in the CCHS changed in 2005 and therefore it is not possible to have the same `age` categories across all CCHS cycles. `cchsflow` offers two options The first option is to transform the `age` variable into two variables. `DHHGAGE_A` is the age variable for CCHS cycles 2001-2003, and `DHHGAGE_B` is the age variable for CCHS cycles 2005-2014. With this option, you cannot combine `DHHGAGE_A` and `DHHGAGE_B` into a single dataset.

```{r, warning=FALSE}
age2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", variables = c("DHHGAGE_A"))
```

```{r, echo=FALSE}
datatable(age2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
age2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", variables = c("DHHGAGE_B"))
```

```{r, echo=FALSE}
datatable(age2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```


#### Example 3.2: transform the categorical `age` variable into a continuous `age` variable

The categorical `age` variable can also be transformed into a single continuous `age` variable. This variable takes the midpoint age of each category for all CCHS cycles. With this option, the age category variable from all CCHS cycles can be combined into a single dataset.

```{r, warning=FALSE}
age2001_cont <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", variables = c("DHHGAGE_cont"))
```

```{r, echo=FALSE}
datatable(age2001_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning=FALSE}
age2013_cont <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", variables = c("DHHGAGE_cont"))
```

```{r, echo=FALSE}
datatable(age2013_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

```{r, warning= FALSE}
combinedAge_cont <- bind_rows(age2001_cont, age2013_cont)
```

```{r, echo=FALSE}
datatable(combinedAge_cont, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:1)), dom = 't'))
```

### Step 3. Labelling your dataset.

`RecWTable()` labels individual datasets, while `SetDataLabels()` labels combined dataset that lose labels during the binding process. Use the `SetDataLabels()` function to label the variables in your final dataset. 

`labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)`

### Example 4. Transform multiple variables from multiple datasets

The variables argument in `RecWTable()` is able to handle multiple variables to be transformed from a CCHS dataset. In this example, the age and sex variables from the 2001 and 2013 CCHS datasets will be transformed and labelled using `RecWTable()`. They will then be combined into a single dataset and labelled using `SetDataLabels()`.

```{r, warning=FALSE}
agesex_2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file", variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(agesex_2001)

agesex_2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component", variables = c("DHHGAGE_cont", "DHH_SEX"), varLabels = c(DHHGAGE_cont = "Age", DHH_SEX = "Sex"))

get_label(agesex_2013)
```

In the above code, varLabels is called in `RecWTable()` to label the age and sex variables in the 2001 and 2013 datasets. To ensure that the variables in your dataset are labelled, use `get_label()` to view the variable labels in your transformed dataset. As mentioned previously, varLabels can be used all the variables in `variablesSheet.csv` or a subset of variables. 

```{r, warning=FALSE}
combinedAgeSex <- bind_rows(agesex_2001, agesex_2013)
labelledCombinedAgeSex <- SetDataLabels(dataToLabel = combinedAgeSex, variableDetails = varDetails, variablesSheet = varSheet)
```

```{r, echo=FALSE}
datatable(labelledCombinedAgeSex, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:2)), dom = 't'))
```

In the above code, `SetDataLabels()` is used to label the combined age and sex dataset. Similar to before, you can check if labels have been added using `get_label()`.

```{r, warning=FALSE}
get_label(labelledCombinedAgeSex)
```

For more information on `get_label()` and other label helper functions, please refer to the [sjlabelled](https://strengejacke.github.io/sjlabelled/reference/) package.

### Example 5. Transform all variables in the variableDetails sheet

All the variables listed in `varDetails.csv` will be transformed if the variables argument in `RecWTable()` is not specified. In this example, all of the variables in our mock 2001 and 2013 datasets will be transformed, combined, and labelled.

```{r, echo=FALSE}
options(htmlwidgets.TOJSON_ARGS = list(na = 'string'))
```

```{r, warning=FALSE}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file")
```

```{r, echo=FALSE}
datatable(transformed2001, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:4)), dom = 't'))
```

```{r, warning=FALSE}
transformed2013 <- RecWTable(dataSource = cchsMock2013, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2013-2014-Annual-component")
```

```{r, echo=FALSE}
datatable(transformed2013, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:4)), dom = 't'))
```

```{r, warning=FALSE}
combinedCCHS <- bind_rows(transformed2001, transformed2013)
labelledCombinedCCHS <- SetDataLabels(dataToLabel = combinedCCHS, variableDetails = varDetails, variablesSheet = varSheet)
```

```{r, echo=FALSE}
datatable(labelledCombinedCCHS, options = list(columnDefs = list(list(className = 'dt-center', targets = 0:5)), dom = 't'))
```

```{r, warning=FALSE}
get_label(labelledCombinedCCHS)
```

### Step 4. Warning messages

Warning messages will appear when the variables in your dataset do not match the variables in your two worksheets. 

In our example, our mock CCHS datasets only contain a two of variables from `variables.csv` and `varDetails.csv`. 

As such, warning messages about variables not included in our datasets will be printed. 

```{r, echo=FALSE, results="hide", warning=2}
transformed2001 <- RecWTable(dataSource = cchsMock2001, variableDetails = varDetails, datasetName = "cchs-82M0013-E-2001-c1-1-general-file")
```

## Using your own CCHS dataset to transform variables

As mentioned previously, CCHS datasets cannot be shared publicly. But that does not mean you cannot use a saved CCHS dataset on your computer to transform variables. Below illustrates a code that can be used to load a CCHS dataset onto your R environment.

```{r, eval=FALSE}
cchsDataset <- read.csv("~/Documents/cchsdataset.csv")
```

You can copy this code to your clipboard and modify the path to where your dataset is saved onto your computer.