---
title: 'cchsflow: An open science approach to transform & combine population health
  surveys into one dataset'
csl: ../elsevier-vancouver.csl
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
bibliography: ../bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

You are a public health epidemiologist who wants to examine the change in Body Mass Index (BMI) in your health unit over the past 15 years. You review the codebook for the Canadian Community Health Survey (CCHS) and note that BMI is collected. BMI _seems_ like a straightforward measure that is routinely collected worldwide.[@StatisticsCanada2001] Indeed, BMI is included in all CCHS cycles. You examine the documentation and find the variable HWTAGBMI in the CCHS 2001 corresponds to body mass index, but that in other cycles, the variable name changes to HWTCGBMI, HWTDGBMI, HWTEGBMI, etc. On reading the documentation, you notice that some cycles round the value to one decimal, whereas other cycles round to two digits. Furthermore, some cycles donâ€™t calculate BMI for respondents under the age of 20 or over the age of 64 years. Also, some cycles calculate BMI only if height and weight are within specific ranges. After spending hours on the task, you talk with a collegue in a neighbouring health unit. They did the same task a few years ago. You share your Stata code by email and compare notes, only to realize that you both had different approaches, each with errors. 

We present an open science approach to transforming and harmonizing the CCHS surveys. Open science is the movement to improve research reproducibility, accessibility, and collaboration.[@Ross2013] Public health practice strives for these qualities and can potentially benefit from the same tools used to support open science. 

We created a process called _cchsflow_ that currently harmonizes 160 variables for CCHS Public Use Microdata File (PUMF) from 2001 to 2014. Users of _cchsflow_ contribute to the package, including making suggestions and requests, and identify errors. People can also "fork" the package meaning they can use the _cchsflow_ approach to harmonize other databases. _cchsflow_ uses R language package since R is the most commonly used open statistical programming language. The core of _cchsflow_, however, are references files that could be used in other programming languages.

Even this paper was created using the open science principles that were used for _cchsflow_. This paper was written using R markdown - a notebook that allows R code to be executed within the document. The notebook is available on [GitHub](https://github.com/Big-Life-Lab/cchsflow/blob/paper-writeups/papers/CJPH/cjph-paper.Rmd) which allows readers to make comments, suggestions or note errors. Readers can execute or modify all examples in this paper in R.

\pagebreak
## Background

### Cleaning and transforming CCHS datasets

Data cleaning, including transforming variables into harmonized or common variables, is typically the most time consuming part of data analyses. According to Dasu & Johnson, 80% of data analysis is spent on data cleaning.[@Dasu2003] With the CCHS, similar issues arise when combining CCHS surveys for longitudinal analysis. Currently, there is no standardized method or tool used to combine CCHS survey cycles. Health units across Canada that use the CCHS do their own data cleaning and preparation, taking time away from other data analysis.   

### Open science and its benefits to public health practice

Open science is defined as "transparent and accessible knowledge that is shared and developed through collaborative networks".[@Vicente-Saez2018] Included in open science is: open data, data that is publicly accessible such as the CCHS with Statistics Canada's new Open License[ref]; open source, the use of open access programs such as data science languages including R, Python and Julia, and; open methodology, program code that is publicly accessible and shared.[@McKiernan2016; @Stodden2013] In public health, there has also been a marked trend toward open data and sharing code - notably during the covid-19 pandemic.[@moorthy2020data]

Adopting open science practices comes with benefits. McKiernan et al. found that open science is associated with increased research exposure in both media and in citations; and an increase in collaboration, funding, and job opportunities.[@McKiernan2016] For public health professionals, an open science approach and toolkit facilitates collaboration as it allows for data & coding methods to be shared between different health units. Additional benefits include improved transparency, accessibility, efficiency, reduced coding errors and faster analyses. The objective for public health practitioners is to improve and compress many time consuming, repetitive, inconsistent analyses tasks.

\pagebreak

## Objectives

The objective of _cchsflow_ was to develop an open R package to minimize the amount of time spent cleaning and transforming CCHS variables across multiple survey cycles. This package would be in constant development, and open to contributions & feedback from public health users. 

## Methods

_cchsflow_ followed the approach of the Open Source Initiate and open software for research.[@OSI][@JOSS] _cchflow_ was created in R with provisions to support other program languages such as Stat or SAS.[@cchsflow] The package currently supports the first 10 cycles of the CCHS Public Use Microdata File (PUMF) surveys from 2001 to 2013, in which the variables of each were harmonized and transformed to use the same set of variables. Variable harmonization & transformation refers to the standardization of variables so that variables have the same name & category stucture across multiple survey cycles. In _cchsflow_, variables were renamed to the variable names used in CCHS cycles from 2007 to 2014 as they have shown to be most consistent. 

### Selection of variables

Variables included in _cchsflow_ include three categories: health behaviours, sociodemographic information, and health status. There are provisions and instructions how users can contribute or request the addition of new variables. 

In Gochman's handbook on health behaviour research, he defines health behaviours as "overt behavioral patterns, actions and habits that relate to health, to health restoration and to health improvement".[@Gochman1997] This definition encompasses a wide variety of behaviours such as, smoking, alcohol, diet, and physical activity.[@Conner2017] For this project, the aforementioned behaviours were examined using existing CCHS variables, as well as derived variables. With respect to sociodemographic information, variables such as age, sex, immigration status, country of birth, time spent in Canada, ethnicity, education (individual and highest family), income (adjusted for province and inflation), home ownership, and marital status were collected and added to the _cchsflow_ library. According to Shah, health status can be defined as "[t]he degree to which a person is able to function physically, emotionally, socially, with or without aid from the healthcare system.".[@Shah2003] Within this definition of health status lies health conditions, human function, well-being, and deaths. Within this project, variables relating to health conditions, human function, and well-being were collected. Deaths were not collected as CCHS data included only living respondents.   

### Variable mapping

CCHS variables were transformed and into a common from across the 10 survey cycles. For many variables, the only difference between cycles were their variable name; as such, only a name change was required to standardize a variable across the 10 cycles. 

Changes in the number and type of categories was also common. For example, in the 2001 and 2003 CCHS survey cycles, there were 15 age categories; while in CCHS survey cycles from 2005 to 2014, there were 16 age categories. There were two options for such variable category changes. The first option was to create a harmonized variable by collapsing categories into common forms. The second option maintained separate variables. For age we also included a third option to maximize age information by deriving a new continuous age variable was derived that takes the midpoint of each age category for all cycles.

There were also changes to question wording, missing categories, inclusion and exclusion criteria. Variables where not included in all cycles or all health regions.  We included harmonized variables when there was a consensus amongst developers that the differences across cycles where small. _notes_ are included when any difference was identified, with a default to print all notes during transformations.

### Transformation of variables through specification worksheets

Two worksheets are included in the _cchsflow_ packages that contain variable information and metadata:  *variables.csv* specifies all the variables in the package. *variable_details.csv* specifies CCHS data that contain the variables, the variable type, and the category structure. 

_rec_with_table()_, short for 'recode with table' is the key function to transform variables. _rec_with_table()_ uses the two worksheets to create a transformed data from a CCHS cycle. Once all CCHS survey cycles have been transformed, they can combined to create one large transformed data set that spans across the 10 CCHS survey cycles. The two CSV worksheets also has variable labels and other metadata that can be added to the data using the _rec_with_table()_ function. 

### Derived variables

CCHS includes derived variables that were created using multiple responses and variables. BMI is an example of an original CCHS derived variable that was calculated using self-reported height and weight. Several new derived variables were included including were also generated in the _cchsflow_ package and there are provisions and instructions for adding additional variables. These variables were based on derived variables used in previous studies and include smoking pack-years, binge drinking and diet pattern.[@Manuel2016] 
 
```{r, echo=FALSE}
library(DiagrammeR)
flowchart <- grViz("digraph flowchart {
              graph [layout = dot, overlap = true, ranksep = 1, nodesep = 1]
              # node definitions with subtituted label text
              node [shape = rectangle, fontsize = 20]
              tab1 [label = '@@1']
              tab2 [label = '@@2']
              tab3 [label = '@@3']
              tab4 [label = '@@4']
              tab5 [label = '@@5']
              tab6 [label = '@@6']
              tab7 [label = '@@7']
              tab8 [label = '@@8']
              tab9 [label = '@@9']
              
      
              # edge definitions with the node IDs
              tab1 -> tab2 -> tab3 
              tab3 -> tab5 [label = ' Yes', fontsize = 20]
              tab3 -> tab4 [label = ' No', fontsize = 20]
              tab4 -> tab6 [label = ' Yes', fontsize = 20]
              tab4 -> tab8 [label = ' No', fontsize = 20]
              tab5 -> tab9 [label = ' Yes', fontsize = 20]
              tab5 -> tab7 [label = ' No', fontsize = 20]
              }
      
              [1]: 'Identify a variable to be\\nadded to cchsflow.'
              [2]: 'Identify which CCHS survey\\ncycles this variable is in.'
              [3]: 'Are the categories consistent\\nacross cycles?'
              [4]: 'Can categories be collapsed to\\nbecome consistent? Or can it be converted into\\na categorical variable?'
              [5]: 'Are the variable names\\nconsistent across cycles?'
              [6]: 'Create a derived categorical variable\\nwith collapsed categories for all cycles;\\nor create a derived continuous variable using\\nmidpoints of each category.'
              [7]: 'Rename variable to common name\\nused from 2007-2014.'
              [8]: 'Cannot harmonize into one final variable.\\nCombine variables that are consistent.'
              [9]: 'No transformations needed, specify\\nwhich survey cycles variable is in.'
              ")

flowchart
```

**Figure 1**: Flowchart of how to add a CCHS variable to cchsflow. 
 
### Collaboration with other users

Collaboration is facilitated using GitHub, the most popular on-line code repository with over 45 million users. Github is based on the Git version-control system which, in turn, is a cornerstone of open software development.[@Dabbish2012] Users add new variable transformations using the worksheets and then create a 'pull request' or PR to add the transformation to the main _cchsflow_ package.  Users can also request variables to be added or identify issues using the 'issues' feature.

### Documentation

Open source, web-based documentation is available at [https://big-life-lab.github.io/cchsflow/](https://big-life-lab.github.io/cchsflow/)
and includes a searchable reference of all transformation, vignettes of examples of how to perform transformations, collaboration principles, a development roadmap.

![](images/Figure1.png)

**Figure 2:** The homepage for the cchsflow GitHub repository.

\pagebreak

## Results

The _cchsflow_ is available on Comprehensive R Archive Network (CRAN), a network of servers that contain documentation for R packages [@CRAN2020]. As of version 1.6.0, _cchsflow_ includes support for CCHS PUMF datasets from 2001 to 2014, and contains 160 variables.[@cchsflow] Once combined, users have access to 1,092,951 survey respondents over a 13 year time period. The _cchsflow_ package contains the following items: the *variables.csv* worksheet, the *variable_details.csv* worksheet, the various functions, and subsets of 200 respondents for each CCHS cycle.

**Figure 3a** illustrates the command line to install the CRAN version of _cchsflow_, while **Figure 3b** illustrates the command to install the development version of _cchsflow_, which is a more up to date version of the package.

```{r, eval=FALSE}
install.packages("cchsflow")
```
**Figure 3a:** The command line to install the _cchsflow_ package that is currently saved on CRAN.

```{r, eval=FALSE}
devtools::install_github("Big-Life-Lab/cchsflow")
```
**Figure 3b:** The command line to install the development version of _cchsflow_ from Github.

### Recode with table

The _rec_with_table()_ function is used to recode or transform variables based on the information from the two specification worksheets. The function has the ability to transform an entire data set, or a subset of variables. **Figure 4a** illustrates how to load the _cchsflow_ package, the 2001 CCHS data and then transform all variables in _cchsflow_ to their harmonized version.  The _cchsflow_ package comes with a subsample of CCHS data for 2001 to 2013 versions, made possible with Statistics Canada new Open Lincence.[@StatisticsCanada2019]. **Figure 4b** illustrates how to transform a subset of variables from the 2001 survey cycle.    

```{r, eval=FALSE}
library(cchsflow)
cchs2001 <- read.csv("~/data/cchs2001.csv")
transformed_cchs <- rec_with_table(cchs2001)
```
**Figure 4a:** The command lines to load the _cchsflow_ package, load the 2001 CCHS PUMF data and then transform the all variables in the worksheets using the _rec_with_table()_ function. 

```{r, eval=FALSE}
library(cchsflow)
cchs2001 <- read.csv("~/data/cchs2001.csv")
transformed_cchs2001 <- rec_with_table(cchs2001, c("DHH_SEX", "DHHGAGE_cont"))
```
**Figure 4b:** The command lines to transform the sex & age variables using the _rec_with_table()_ function.


\pagebreak

## Discussion

In this project, an R package called _cchsflow_ was created that harmonizes and transforms data from 2001 to 2014.[@cchsflow] _cchsflow_ provided public health epidemiologists and others the ability to more robustly analyze over 1 million respondents across a 13 year period to examine trends in health indicators. An open science approach improves collaboration, transparency and efficiency when transforming variables. The package allows public health professionals that use CCHS  to spend less time on data cleaning, and spend more time on analysis such as surveillance and health status reporting. 

_cchsflow_ extends the current approach of 

- https://www.apheo.ca/core-indicators-work-group
- DDI
- Maelstrom
- OHDP
- https://indicatorlibrary.cihi.ca/display/HSPIL/Indicator+Library?desktop=true&_ga=2.214437141.328439497.1597831848-1908179218.1597831848
- https://www.canada.ca/content/dam/phac-aspc/documents/services/publications/science-research/key-health-inequalities-canada-national-portrait-executive-summary/key_health_inequalities_full_report-eng.pdf


While the CCHS aims to be consistent across survey cycles, there can be differences between cycles that can sometimes be irreconcilable with a simple variable name change. Within the CCHS, there are variables that are measured differently or categorized differently. Within _cchsflow_, variables with irreconcilable differences were either transformed into a new derived variable, or kept as separate variables that can be only be used in select cycles. Along with variables with irreconciliable differences, there are variables in _cchsflow_ that were not asked in all CCHS cycles. This means for some variables, data does not span across the length of the CCHS cycles available in _cchsflow_. For users looking to examine specific CCHS cycles this does not pose as an issue. For those looking to use all available cycles in _cchsflow_, further data manipulation will need to be done. A possible solution is to implement imputation, where missing data is replaced with values on based on other respondents and responses to other variables. 

The open-access nature of the _cchsflow_ package also allows users to add other CCHS variables that might benefit others. On the _cchsflow_ GitHub [page](https://github.com/Big-Life-Lab/cchsflow/), users can either add variables, or request new variables to be transformed and added to the package. With the entire _cchsflow_ repository on GitHub, there is complete transparency on how the package was developed as the entire source code for the package is publicly accessible on the repository. Along with being transparent, putting the _cchsflow_ package on GitHub offers users of the package the opportunity to provide feedback on how to further improve the package. In the issues section of the GitHub repository, users can submit bug reports where they can identify issues they are encountering while using the package. Another way users can contribute to the _cchsflow_ package is through the use of "pull requests", a GitHub feature where users can request their code to be merged into the existing repository. How this works in the context of _cchsflow_ is that users can create a branch off the "master" branch of _cchsflow_, make changes to the specification worksheets by adding variables and/or adding custom functions for derived variables, and then initiate a pull request to request those changes to be merged into the package. Research has shown that GitHub provides benefit to users in that it provides them an opportunity to implement better practices in their own code [@Dabbish2012]. The implementation of GitHub in the development of _cchsflow_ allows public health professionals across Canada to collaborate and share potential variables that can be useful for health surveillance and health status reporting. 

### Limitations

While there are many strengths to this project, there are also several limitations. For the development of the _cchsflow_ package, the Public Use Microdata File (PUMF) was used for each CCHS survey cycle. Unlike in the CCHS share data files which contain all variables, PUMF datasets remove or aggregate variables that may potentially identify a respondent [@StatisticsCanada2014]. In doing so, several variables that may be predictive in health data research were not included. These include socioeconomic risk factors like deprivation index, marginalization index, and urbanity/rurality of respondent and their household. While socioeconomic risk factors play a role in identifying various determinants of health [@Bushnik2020], open science practices mean such confidential variables cannot be used or accessed in analysis.

## Conclusion

In this project, an R package called _cchsflow_ was created that transforms and harmonizes variables from the Canadian Community Health Survey from 2001 to 2014, generating a dataset of over 1 million respondents. The _cchsflow_ package is an open source package, and encourages the contribution & collaboration of public health professionals that use CCHS data. While there are limitations in what data can be shared due to confidentiality, open science is a vital tool in public health as it is transparent and improves the collection and preparation of data for users of health data. This allows for enhanced surveillance and health status reporting. Open science also allows public health professionals to collaborate and share their work with other colleagues, saving time recoding and cleaning health datasets. By implementing open science practices, _cchsflow_ aims to minimize the amount of time needed to clean and prepare CCHS data for the many CCHS users in health units across Canada.

\pagebreak

## References
